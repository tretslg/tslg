<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Siegel Law Group, P.A. | Training Hub</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyDx5qmoBIK5NURZLrTKUyL0ujlVDD-aLyU",
            authDomain: "siegel-law-group-training.firebaseapp.com",
            projectId: "siegel-law-group-training",
            storageBucket: "siegel-law-group-training.firebasestorage.app",
            messagingSenderId: "352509909326",
            appId: "1:352509909326:web:287c47c2dcdf6b0714a61f",
            measurementId: "G-K6E49W7HP6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        
        // Add Firestore for data persistence
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        const firestoreDb = getFirestore(app);
        
        // Add Firebase Storage for file uploads
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";
        const firebaseStorage = getStorage(app);
        
        // Make Firebase available globally
        window.firebaseApp = app;
        window.firebaseDb = firestoreDb;
        window.firebaseStorage = firebaseStorage;
        window.firebaseAnalytics = analytics;
        
        // Test Firebase connectivity
        async function testFirebaseConnection() {
            try {
                console.log('üß™ Testing Firebase connection...');
                const testDoc = doc(firestoreDb, 'test', 'connection');
                await setDoc(testDoc, { timestamp: Date.now(), test: true });
                console.log('‚úÖ Firebase connection successful!');
                
                // Clean up test document
                await setDoc(testDoc, {});
                return true;
            } catch (error) {
                console.error('‚ùå Firebase connection failed:', error);
                return false;
            }
        }
        
        // Test connection and dispatch event when ready
        testFirebaseConnection().then(success => {
            if (success) {
                console.log('üöÄ Firebase ready for use');
                window.dispatchEvent(new Event('firebase-ready'));
            } else {
                console.log('‚ö†Ô∏è Firebase not available, using localStorage fallback');
                // Still dispatch event so app can work with localStorage
                window.dispatchEvent(new Event('firebase-ready'));
            }
        });
    </script>
    <style>
        :root {
            --tnt-dark-blue: #0f1b4c;
            --tnt-pink: #ff006B;
            --tnt-light-gray: #f8fafc;
            --tnt-border-gray: #e2e8f0;
            --tnt-text-primary: #1e293b;
            --tnt-text-secondary: #64748b;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--tnt-light-gray); color: var(--tnt-text-primary); }
        .sidebar-link.active { background-color: #f1f5f9; color: var(--tnt-pink); font-weight: 600; }
        .tnt-button { background-color: var(--tnt-pink); color: white; }
        .tnt-button:hover { background-color: #d6005b; }
        .modal-overlay { background-color: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); z-index: 1000; }
        .progress-bar-fill { background-color: var(--tnt-pink); }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .content-card { background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="bg-slate-50">

    <div class="flex h-screen bg-white">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-white border-r border-[var(--tnt-border-gray)] flex flex-col">
            <div class="p-6 text-center border-b border-[var(--tnt-border-gray)]">
                <div class="w-16 h-16 bg-gradient-to-br from-sky-500 to-pink-500 rounded-xl flex items-center justify-center shadow-lg mx-auto">
                    <span class="text-white font-bold text-xl">TSLG</span>
                </div>
            </div>
            <div class="p-4">
                <div class="relative mb-4">
                    <span data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></span>
                    <input type="text" id="global-search" placeholder="Search all resources..." class="w-full bg-slate-100 border border-slate-200 rounded-md pl-10 pr-4 py-2 text-sm focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                </div>
                <!-- Add New Resource Button -->
                <button id="add-resource-btn" class="w-full bg-[var(--tnt-pink)] text-white py-2 px-4 rounded-md text-sm font-medium hover:bg-[#d6005b] transition-colors flex items-center justify-center">
                    <span data-lucide="plus" class="w-4 h-4 mr-2"></span>
                    Add New Resource
                </button>
            </div>
            <nav id="main-nav" class="flex-grow p-4 space-y-2">
                <!-- Navigation Links will be injected by JS -->
            </nav>
            <div id="user-profile" class="p-4 border-t border-[var(--tnt-border-gray)]">
                <!-- User Profile will be injected by JS -->
            </div>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 overflow-y-auto p-6 md:p-10">
            <!-- Content will be injected by JS -->
        </main>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 id="login-modal-title" class="text-2xl font-bold text-slate-900">Login to The Siegel Law Group Academy</h2>
                <button class="close-modal-btn text-slate-400 hover:text-slate-600" data-modal-id="login-modal">
                    <span data-lucide="x" class="w-6 h-6"></span>
                </button>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                    <input type="email" id="login-email" required class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                    <input type="password" id="login-password" required class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                </div>
                <button type="submit" class="w-full bg-[var(--tnt-pink)] text-white py-3 px-4 rounded-md font-medium hover:bg-[#d6005b] transition-colors">
                    Login
                </button>
            </form>
            <div class="mt-4 text-center">
                <p class="text-sm text-slate-500">Don't have an account? Contact your administrator.</p>
            </div>
        </div>
    </div>

    <!-- Add Resource Modal -->
    <div id="add-resource-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-900">Add New Resource</h2>
                <button class="close-modal-btn text-slate-400 hover:text-slate-600" data-modal-id="add-resource-modal">
                    <span data-lucide="x" class="w-6 h-6"></span>
                </button>
            </div>
            <form id="add-resource-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="resource-title" class="block text-sm font-medium text-slate-700 mb-1">Title *</label>
                        <input type="text" id="resource-title" required class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                    </div>
                    <div>
                        <label for="resource-type" class="block text-sm font-medium text-slate-700 mb-1">Type *</label>
                        <select id="resource-type" required class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                            <option value="">Select Type</option>
                            <option value="Training">Training Video</option>
                            <option value="SOP">Standard Operating Procedure</option>
                            <option value="Template">Template/Form</option>
                            <option value="Resource">Resource/Guide</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="resource-department" class="block text-sm font-medium text-slate-700 mb-1">Department *</label>
                        <select id="resource-department" required class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                            <option value="">Select Department</option>
                            <option value="Estate Planning">Estate Planning</option>
                            <option value="Elder Law">Elder Law</option>
                            <option value="Medicaid Planning">Medicaid Planning</option>
                            <option value="Trust Administration">Trust Administration</option>
                            <option value="Probate">Probate</option>
                            <option value="Attorneys">Attorneys</option>
                            <option value="Operations">Operations</option>
                            <option value="Human Resources">Human Resources</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Sales">Sales</option>
                        </select>
                    </div>
                    <div>
                        <label for="resource-author" class="block text-sm font-medium text-slate-700 mb-1">Added By *</label>
                        <input type="text" id="resource-author" required class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                    </div>
                </div>
                <div>
                    <label for="resource-url" class="block text-sm font-medium text-slate-700 mb-1">URL/Link, File Upload, or Media Library</label>
                    <div class="space-y-3">
                        <input type="url" id="resource-url" class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent" placeholder="https://... (or upload file below)">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-slate-500">OR</span>
                        </div>
                        <div>
                            <input type="file" id="resource-file" accept="video/*,audio/*,.pdf,.doc,.docx,.txt,.ppt,.pptx,.xls,.xlsx" class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                            <p class="text-xs text-slate-500 mt-1">Upload files: Videos, Audio, PDFs, Documents, Presentations, Spreadsheets</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-slate-500">OR</span>
                        </div>
                        <button type="button" id="browse-media-btn" class="w-full p-3 border border-slate-300 rounded-md hover:bg-slate-50 text-slate-600 font-medium flex items-center justify-center">
                            <span data-lucide="image" class="w-4 h-4 mr-2"></span>
                            üìö Browse Media Library
                        </button>
                        <div id="selected-media-display" class="hidden bg-green-50 border border-green-200 rounded-lg p-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <span data-lucide="check-circle" class="w-5 h-5 text-green-600 mr-2"></span>
                                    <span class="text-sm font-medium text-green-800" id="selected-media-title"></span>
                                </div>
                                <button type="button" id="clear-selected-media" class="text-red-600 hover:text-red-800">
                                    <span data-lucide="x" class="w-4 h-4"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="resource-description" class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                    <textarea id="resource-description" rows="3" class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent" placeholder="Brief description of the resource..."></textarea>
                </div>
                <div>
                    <label for="resource-skills" class="block text-sm font-medium text-slate-700 mb-1">Skills Covered (comma-separated)</label>
                    <input type="text" id="resource-skills" class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent" placeholder="e.g., Google Ads, Conversion Tracking, Analytics">
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" class="close-modal-btn px-4 py-2 text-slate-600 border border-slate-300 rounded-md hover:bg-slate-50" data-modal-id="add-resource-modal">Cancel</button>
                    <button type="submit" class="bg-[var(--tnt-pink)] text-white px-6 py-2 rounded-md font-medium hover:bg-[#d6005b] transition-colors">Add Resource</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard Modal -->
    <div id="admin-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-900">Admin Dashboard</h2>
                <button class="close-modal-btn text-slate-400 hover:text-slate-600" data-modal-id="admin-modal">
                    <span data-lucide="x" class="w-6 h-6"></span>
                </button>
            </div>
            <div id="admin-content">
                <!-- Admin content will be injected by JS -->
            </div>
        </div>
    </div>

        <!-- Add Member Modal -->
    <div id="add-member-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-900">Add New Member</h2>
                <button class="close-modal-btn text-slate-400 hover:text-slate-600" data-modal-id="add-member-modal">
                    <span data-lucide="x" class="w-6 h-6"></span>
                                </button>
                            </div>
            <form id="add-member-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="member-name" class="block text-sm font-medium text-slate-700 mb-1">Full Name *</label>
                        <input type="text" id="member-name" required class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                        </div>
                    <div>
                        <label for="member-email" class="block text-sm font-medium text-slate-700 mb-1">Email *</label>
                        <input type="email" id="member-email" required class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="member-title" class="block text-sm font-medium text-slate-700 mb-1">Job Title *</label>
                        <input type="text" id="member-title" required class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                    </div>
                    <div>
                        <label for="member-department" class="block text-sm font-medium text-slate-700 mb-1">Department *</label>
                        <select id="member-department" required class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                            <option value="">Select Department</option>
                            <option value="Estate Planning">Estate Planning</option>
                            <option value="Elder Law">Elder Law</option>
                            <option value="Medicaid Planning">Medicaid Planning</option>
                            <option value="Trust Administration">Trust Administration</option>
                            <option value="Probate">Probate</option>
                            <option value="Attorneys">Attorneys</option>
                            <option value="Operations">Operations</option>
                            <option value="Human Resources">Human Resources</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Sales">Sales</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="member-password" class="block text-sm font-medium text-slate-700 mb-1">Initial Password *</label>
                        <input type="password" id="member-password" required class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent" placeholder="Minimum 8 characters">
                    </div>
                    <div>
                        <label for="member-role" class="block text-sm font-medium text-slate-700 mb-1">Role *</label>
                        <select id="member-role" required class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                            <option value="user">Team Member</option>
                            <option value="admin">Administrator</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" class="close-modal-btn px-4 py-2 text-slate-600 border border-slate-300 rounded-md hover:bg-slate-50" data-modal-id="add-member-modal">Cancel</button>
                    <button type="submit" class="bg-[var(--tnt-pink)] text-white px-6 py-2 rounded-md font-medium hover:bg-[#d6005b] transition-colors">Add Member</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Member Modal -->
    <div id="edit-member-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-900">Edit Member</h2>
                <button class="close-modal-btn text-slate-400 hover:text-slate-600" data-modal-id="edit-member-modal">
                    <span data-lucide="x" class="w-6 h-6"></span>
                </button>
            </div>
            <form id="edit-member-form" class="space-y-4">
                <input type="hidden" id="edit-member-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="edit-member-name" class="block text-sm font-medium text-slate-700 mb-1">Full Name *</label>
                        <input type="text" id="edit-member-name" required class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                    </div>
                    <div>
                        <label for="edit-member-email" class="block text-sm font-medium text-slate-700 mb-1">Email *</label>
                        <input type="email" id="edit-member-email" required class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="edit-member-title" class="block text-sm font-medium text-slate-700 mb-1">Job Title *</label>
                        <input type="text" id="edit-member-title" required class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                    </div>
                    <div>
                        <label for="edit-member-department" class="block text-sm font-medium text-slate-700 mb-1">Department *</label>
                        <select id="edit-member-department" required class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                            <option value="">Select Department</option>
                            <option value="Estate Planning">Estate Planning</option>
                            <option value="Elder Law">Elder Law</option>
                            <option value="Medicaid Planning">Medicaid Planning</option>
                            <option value="Trust Administration">Trust Administration</option>
                            <option value="Probate">Probate</option>
                            <option value="Attorneys">Attorneys</option>
                            <option value="Operations">Operations</option>
                            <option value="Human Resources">Human Resources</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Sales">Sales</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="edit-member-role" class="block text-sm font-medium text-slate-700 mb-1">Role *</label>
                        <select id="edit-member-role" required class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                            <option value="user">Team Member</option>
                            <option value="admin">Administrator</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-member-access" class="block text-sm font-medium text-slate-700 mb-1">Access Level *</label>
                        <select id="edit-member-access" required class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                            <option value="standard">Standard Access</option>
                            <option value="admin">Admin Access</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="edit-member-status" class="block text-sm font-medium text-slate-700 mb-1">Status *</label>
                    <select id="edit-member-status" required class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Profile Picture</label>
                    <div class="flex items-center space-x-4">
                        <img id="edit-member-avatar-preview" src="https://i.ibb.co/2S8p5z3/avatar.png" alt="Profile" class="w-16 h-16 rounded-full object-cover border-2 border-slate-200">
                        <div class="flex-1 space-y-3">
                            <!-- Upload from device -->
                            <div>
                                <label for="edit-member-avatar" class="block text-xs font-medium text-slate-600 mb-1">Upload from device:</label>
                                <input type="file" id="edit-member-avatar" accept="image/*" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent text-sm">
                                <p class="text-xs text-slate-500 mt-1">JPG, PNG, GIF (max 5MB)</p>
                            </div>
                            
                            <!-- Or select from media library -->
                            <div>
                                <label class="block text-xs font-medium text-slate-600 mb-1">Or select from Media Library:</label>
                                <button type="button" id="select-avatar-from-media" class="w-full p-2 border border-slate-300 rounded-md hover:bg-slate-50 focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent text-sm flex items-center justify-center">
                                    <span data-lucide="image" class="w-4 h-4 mr-2"></span>
                                    Choose from Media Library
                                </button>
                                <p class="text-xs text-slate-500 mt-1">Select from previously uploaded images</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" class="close-modal-btn px-4 py-2 text-slate-600 border border-slate-300 rounded-md hover:bg-slate-50" data-modal-id="edit-member-modal">Cancel</button>
                    <button type="submit" class="bg-[var(--tnt-pink)] text-white px-6 py-2 rounded-md font-medium hover:bg-[#d6005b] transition-colors">Update Member</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Curriculum Step Modal -->
    <div id="add-curriculum-step-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-900">Add New Curriculum Step</h2>
                <button class="close-modal-btn text-slate-400 hover:text-slate-600" data-modal-id="add-curriculum-step-modal">
                    <span data-lucide="x" class="w-6 h-6"></span>
                </button>
            </div>
            <form id="add-curriculum-step-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="curriculum-title" class="block text-sm font-medium text-slate-700 mb-1">Title *</label>
                        <input type="text" id="curriculum-title" required class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                    </div>
                    <div>
                        <label for="curriculum-type" class="block text-sm font-medium text-slate-700 mb-1">File Type *</label>
                        <select id="curriculum-type" required class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                            <option value="">Select Type</option>
                            <option value="Training">Training Video</option>
                            <option value="SOP">Standard Operating Procedure</option>
                            <option value="Template">Template/Form</option>
                            <option value="Resource">Resource/Guide</option>
                            <option value="Vision">Vision Document</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="curriculum-department" class="block text-sm font-medium text-slate-700 mb-1">Department *</label>
                        <select id="curriculum-department" required class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                            <option value="">Select Department</option>
                            <option value="Estate Planning">Estate Planning</option>
                            <option value="Elder Law">Elder Law</option>
                            <option value="Medicaid Planning">Medicaid Planning</option>
                            <option value="Trust Administration">Trust Administration</option>
                            <option value="Probate">Probate</option>
                            <option value="Attorneys">Attorneys</option>
                            <option value="Operations">Operations</option>
                            <option value="Human Resources">Human Resources</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Sales">Sales</option>
                        </select>
                    </div>
                    <div>
                        <label for="curriculum-author" class="block text-sm font-medium text-slate-700 mb-1">Added By *</label>
                        <input type="text" id="curriculum-author" required class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                    </div>
                </div>
                <div>
                    <label for="curriculum-url" class="block text-sm font-medium text-slate-700 mb-1">URL/Link *</label>
                    <input type="url" id="curriculum-url" required class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent" placeholder="https://...">
                    <p class="text-xs text-slate-500 mt-1">For YouTube videos, we'll automatically pull the thumbnail</p>
                </div>
                <div>
                    <label for="curriculum-description" class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                    <textarea id="curriculum-description" rows="3" class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent" placeholder="Brief description of the resource..."></textarea>
                </div>
                <div>
                    <label for="curriculum-skills" class="block text-sm font-medium text-slate-700 mb-1">Skills Covered (comma-separated)</label>
                    <input type="text" id="curriculum-skills" class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent" placeholder="e.g., Google Ads, Conversion Tracking, Analytics">
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" class="close-modal-btn px-4 py-2 text-slate-600 border border-slate-300 rounded-md hover:bg-slate-50" data-modal-id="add-curriculum-step-modal">Cancel</button>
                    <button type="submit" class="bg-[var(--tnt-pink)] text-white px-6 py-2 rounded-md font-medium hover:bg-[#d6005b] transition-colors">Add Step</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Select Avatar from Media Library Modal -->
    <div id="select-avatar-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-900">Select Profile Picture from Media Library</h2>
                <button class="close-modal-btn text-slate-400 hover:text-slate-600" data-modal-id="select-avatar-modal">
                    <span data-lucide="x" class="w-6 h-6"></span>
                </button>
            </div>
            <div class="space-y-4">
                <!-- Search and filter -->
                <div class="flex space-x-4">
                    <div class="flex-1">
                        <input type="text" id="avatar-search" placeholder="Search images..." class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                    </div>
                    <select id="avatar-filter" class="p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                        <option value="">All Images</option>
                        <option value="image/jpeg">JPEG</option>
                        <option value="image/png">PNG</option>
                        <option value="image/gif">GIF</option>
                    </select>
                </div>
                
                <!-- Media grid -->
                <div id="avatar-media-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- Media items will be populated here -->
                </div>
                
                <!-- No results message -->
                <div id="avatar-no-results" class="hidden text-center py-8 text-slate-500">
                    <span data-lucide="image" class="w-12 h-12 mx-auto mb-4 text-slate-300"></span>
                    <p>No images found in Media Library</p>
                    <p class="text-sm">Upload some images to the Media Library first</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Reorder Curriculum Modal -->
    <div id="reorder-curriculum-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-900">Reorder Curriculum Steps</h2>
                <button class="close-modal-btn text-slate-400 hover:text-slate-600" data-modal-id="reorder-curriculum-modal">
                    <span data-lucide="x" class="w-6 h-6"></span>
                </button>
            </div>
            <div id="reorder-content" class="space-y-4">
                <!-- Reorder content will be injected here -->
            </div>
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" class="close-modal-btn px-4 py-2 text-slate-600 border border-slate-300 rounded-md hover:bg-slate-50" data-modal-id="reorder-curriculum-modal">Cancel</button>
                <button type="button" id="save-reorder-btn" class="bg-[var(--tnt-pink)] text-white px-6 py-2 rounded-md font-medium hover:bg-[#d6005b] transition-colors">Save Order</button>
            </div>
        </div>
    </div>

    <!-- Media Library Picker Modal -->
    <div id="media-picker-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-900">Select Media from Library</h2>
                <button class="close-modal-btn text-slate-400 hover:text-slate-600" data-modal-id="media-picker-modal">
                    <span data-lucide="x" class="w-6 h-6"></span>
                </button>
            </div>
            
            <!-- Search and Filter -->
            <div class="mb-6 bg-slate-50 rounded-lg p-4">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <input type="text" id="picker-search" placeholder="Search media..." class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                    </div>
                    <select id="picker-filter" class="p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                        <option value="">All Types</option>
                        <option value="image">Images</option>
                        <option value="video">Videos</option>
                        <option value="document">Documents</option>
                    </select>
                    <select id="picker-department" class="p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                        <option value="">All Departments</option>
                        <option value="Estate Planning">Estate Planning</option>
                        <option value="Elder Law">Elder Law</option>
                        <option value="Medicaid Planning">Medicaid Planning</option>
                        <option value="Trust Administration">Trust Administration</option>
                        <option value="Probate">Probate</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Sales">Sales</option>
                        <option value="Operations">Operations</option>
                        <option value="Human Resources">Human Resources</option>
                        <option value="Attorneys">Attorneys</option>
                    </select>
                </div>
            </div>
            
            <!-- Media Grid -->
            <div id="picker-media-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4">
                <!-- Media items will be populated here -->
            </div>
            
            <!-- No Results -->
            <div id="picker-no-results" class="hidden text-center py-8">
                <span data-lucide="search" class="w-12 h-12 text-slate-400 mx-auto mb-4"></span>
                <p class="text-slate-500">No media found matching your criteria</p>
            </div>
        </div>
    </div>

    <!-- Add Media Modal -->
    <div id="add-media-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-900">Add Media to Library</h2>
                <button class="close-modal-btn text-slate-400 hover:text-slate-600" data-modal-id="add-media-modal">
                    <span data-lucide="x" class="w-6 h-6"></span>
                </button>
            </div>
            <form id="add-media-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="media-title" class="block text-sm font-medium text-slate-700 mb-1">Title *</label>
                        <input type="text" id="media-title" required class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                    </div>
                    <div>
                        <label for="media-type" class="block text-sm font-medium text-slate-700 mb-1">Media Type *</label>
                        <select id="media-type" required class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                            <option value="">Select Type</option>
                            <option value="image">Image</option>
                            <option value="video">Video</option>
                            <option value="document">Document</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="media-department" class="block text-sm font-medium text-slate-700 mb-1">Department</label>
                        <select id="media-department" class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                            <option value="">General</option>
                            <option value="Estate Planning">Estate Planning</option>
                            <option value="Elder Law">Elder Law</option>
                            <option value="Medicaid Planning">Medicaid Planning</option>
                            <option value="Trust Administration">Trust Administration</option>
                            <option value="Probate">Probate</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Sales">Sales</option>
                            <option value="Operations">Operations</option>
                            <option value="Human Resources">Human Resources</option>
                            <option value="Attorneys">Attorneys</option>
                        </select>
                    </div>
                    <div>
                        <label for="media-tags" class="block text-sm font-medium text-slate-700 mb-1">Tags (comma-separated)</label>
                        <input type="text" id="media-tags" class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent" placeholder="e.g., logo, banner, training">
                    </div>
                </div>
                <div>
                    <label for="media-file" class="block text-sm font-medium text-slate-700 mb-1">Upload File(s) *</label>
                    <input type="file" id="media-file" required accept="image/*,video/*,.pdf,.doc,.docx,.txt,.ppt,.pptx,.xls,.xlsx" class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent" multiple>
                    <p class="text-xs text-slate-500 mt-1">Supported: Images, Videos, Documents, Presentations, Spreadsheets (Select multiple files for bulk upload)</p>
                </div>
                <div>
                    <label for="media-description" class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                    <textarea id="media-description" rows="3" class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent" placeholder="Brief description of this media..."></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" class="close-modal-btn px-4 py-2 text-slate-600 border border-slate-300 rounded-md hover:bg-slate-50" data-modal-id="add-media-modal">Cancel</button>
                    <button type="submit" class="bg-[var(--tnt-pink)] text-white px-6 py-2 rounded-md font-medium hover:bg-[#d6005b] transition-colors">Add to Library</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Resource Confirmation Modal -->
    <!-- Build CRM Curriculum Modal (guided path by role/department) -->
    <div id="crm-curriculum-builder-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-slate-900">Build CRM Curriculum</h2>
                <button type="button" class="close-modal-btn text-slate-400 hover:text-slate-600" data-modal-id="crm-curriculum-builder-modal"><span data-lucide="x" class="w-6 h-6"></span></button>
            </div>
            <p id="crm-builder-subtitle" class="text-sm text-slate-600 mb-4">Add the right trainings for this role. Suggestions stay relevant so learners don't waste time.</p>
            <div class="mb-4">
                <button type="button" id="crm-builder-ai-suggest" class="inline-flex items-center px-4 py-2 bg-[var(--tnt-pink)] text-white rounded-lg text-sm font-medium hover:bg-[#d6005b]">
                    <span data-lucide="sparkles" class="w-4 h-4 mr-2"></span>
                    Get AI suggestions for this role
                </button>
            </div>
            <div id="crm-builder-ai-output" class="hidden mb-4 p-4 bg-slate-50 rounded-lg border text-sm"></div>
            <div id="crm-builder-suggestions-list" class="mb-4 space-y-2"></div>
                            <div class="border-t pt-4 mb-4">
                                <label class="block text-sm font-medium text-slate-700 mb-2">Add custom resource (with optional SOP)</label>
                                <input type="text" id="crm-builder-custom-title" placeholder="Title" class="w-full p-2 border border-slate-300 rounded-md text-sm mb-2">
                                <input type="text" id="crm-builder-custom-desc" placeholder="Description (optional)" class="w-full p-2 border border-slate-300 rounded-md text-sm mb-2">
                                <input type="text" id="crm-builder-custom-url" placeholder="URL or video link" class="w-full p-2 border border-slate-300 rounded-md text-sm mb-2">
                                <textarea id="crm-builder-custom-steps" placeholder="SOP steps, one per line (optional)" class="w-full p-2 border border-slate-300 rounded-md text-sm mb-2" rows="3"></textarea>
                                <button type="button" id="crm-builder-add-custom" class="px-3 py-2 bg-slate-100 hover:bg-slate-200 rounded-md text-sm">Add</button>
                            </div>
            <h3 class="text-sm font-semibold text-slate-700 mb-2">Curriculum items</h3>
            <ul id="crm-builder-items-list" class="space-y-2 mb-4 min-h-[60px]"></ul>
            <div class="flex justify-end gap-2">
                <button type="button" class="close-modal-btn px-4 py-2 border border-slate-300 rounded-md text-slate-700" data-modal-id="crm-curriculum-builder-modal">Cancel</button>
                <button type="button" id="crm-builder-save" class="px-4 py-2 bg-[var(--tnt-pink)] text-white rounded-md font-medium">Save curriculum</button>
            </div>
        </div>
    </div>

    <div id="delete-resource-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex items-center mb-6">
                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mr-4">
                    <span data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></span>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-slate-900">Delete Resource</h2>
                    <p class="text-sm text-slate-500">This action cannot be undone</p>
                </div>
            </div>
            <div class="mb-6">
                <p class="text-slate-700 mb-2">Are you sure you want to delete this resource?</p>
                <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                    <p class="font-medium text-red-800" id="delete-resource-title"></p>
                    <p class="text-sm text-red-600 mt-1">This resource will be permanently removed from the platform.</p>
                </div>
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" class="close-modal-btn px-4 py-2 text-slate-600 border border-slate-300 rounded-md hover:bg-slate-50" data-modal-id="delete-resource-modal">Cancel</button>
                <button type="button" id="confirm-delete-resource" class="bg-red-600 text-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Delete Resource</button>
            </div>
        </div>
    </div>

    <!-- Upload Progress Modal -->
    <div id="upload-progress-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex items-center mb-6">
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mr-4">
                    <span data-lucide="upload" class="w-6 h-6 text-blue-600"></span>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-slate-900">Uploading File</h2>
                    <p class="text-sm text-slate-500" id="upload-status">Preparing upload...</p>
                </div>
            </div>
            <div class="mb-6">
                <div class="flex items-center justify-between text-sm text-slate-600 mb-2">
                    <span id="upload-filename">File name</span>
                    <span id="upload-percentage">0%</span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-3">
                    <div id="upload-progress-bar" class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p class="text-xs text-slate-500 mt-2" id="upload-time-estimate">Please wait...</p>
            </div>
            <div class="flex justify-end">
                <button type="button" id="cancel-upload-btn" class="px-4 py-2 text-slate-600 border border-slate-300 rounded-md hover:bg-slate-50">Cancel Upload</button>
            </div>
        </div>
    </div>


    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // =================================================================================
            // FIREBASE FIRESTORE DATABASE
            // This app now uses Firebase Firestore for real-time data persistence across all users.
            // =================================================================================
            const db = {
                // --- USERS COLLECTION ---
                users: {
                    'creator_001': {
                        id: 'creator_001',
                        name: 'Barry D. Siegel, Esq.',
                        title: 'Founder and CEO',
                        email: 'bsiegel@siegellawgroup.com',
                        avatar: 'https://i.ibb.co/2S8p5z3/avatar.png',
                        department: 'All',
                        role: 'creator',
                        completedItems: [],
                        pinnedItems: [],
                        pathProgress: {},
                        lastLogin: '2024-01-15',
                        status: 'active',
                        joinDate: '2023-01-01'
                    },
                    'user_001': {
                        id: 'user_001',
                        name: 'Tre Forte',
                        title: 'Chief Marketing Officer',
                        email: 'tre@siegellawgroup.com',
                        avatar: 'https://i.ibb.co/2S8p5z3/avatar.png',
                        department: 'Marketing',
                        role: 'admin',
                        accessLevel: 'admin',
                        completedItems: [],
                        pinnedItems: [],
                        pathProgress: { 'onboarding_marketing': 0 },
                        lastLogin: '2024-01-15',
                        status: 'active',
                        joinDate: '2023-06-01'
                    },
                    'user_002': {
                        id: 'user_002',
                        name: 'Abby L. Steinberg',
                        title: 'Attorney',
                        email: 'abby@siegellawgroup.com',
                        avatar: 'https://i.ibb.co/2S8p5z3/avatar.png',
                        department: 'Estate Planning',
                        role: 'user',
                        accessLevel: 'standard',
                        completedItems: [],
                        pinnedItems: [],
                        pathProgress: { 'onboarding_estate_planning': 0 },
                        lastLogin: '2024-01-14',
                        status: 'active',
                        joinDate: '2024-01-05'
                    },
                    'user_003': {
                        id: 'user_003',
                        name: 'Jay Silverstein',
                        title: 'Attorney',
                        email: 'jay@siegellawgroup.com',
                        avatar: 'https://i.ibb.co/2S8p5z3/avatar.png',
                        department: 'Estate Planning',
                        role: 'user',
                        accessLevel: 'standard',
                        completedItems: [],
                        pinnedItems: [],
                        pathProgress: { 'onboarding_estate_planning': 0 },
                        lastLogin: '2024-01-13',
                        status: 'active',
                        joinDate: '2024-01-10'
                    },
                    'user_004': {
                        id: 'user_004',
                        name: 'Maria Siegel',
                        title: 'Medicaid Consultant & Community Outreach Specialist',
                        email: 'maria@siegellawgroup.com',
                        avatar: 'https://i.ibb.co/2S8p5z3/avatar.png',
                        department: 'Medicaid Planning',
                        role: 'user',
                        accessLevel: 'standard',
                        completedItems: [],
                        pinnedItems: [],
                        pathProgress: { 'onboarding_medicaid_planning': 0 },
                        lastLogin: '2024-01-12',
                        status: 'active',
                        joinDate: '2024-01-08'
                    },
                    'user_005': {
                        id: 'user_005',
                        name: 'Jodean Gary',
                        title: 'Sales Manager',
                        email: 'jodean@siegellawgroup.com',
                        avatar: 'https://i.ibb.co/2S8p5z3/avatar.png',
                        department: 'Sales',
                        role: 'user',
                        accessLevel: 'standard',
                        completedItems: [],
                        pinnedItems: [],
                        pathProgress: { 'onboarding_sales': 0 },
                        lastLogin: '2024-01-11',
                        status: 'active',
                        joinDate: '2024-01-07'
                    },
                    'user_006': {
                        id: 'user_006',
                        name: 'Lennice Padilla',
                        title: 'Estate Planning Coordinator',
                        email: 'lennice@siegellawgroup.com',
                        avatar: 'https://i.ibb.co/2S8p5z3/avatar.png',
                        department: 'Estate Planning',
                        role: 'user',
                        accessLevel: 'standard',
                        completedItems: [],
                        pinnedItems: [],
                        pathProgress: { 'onboarding_estate_planning': 0 },
                        lastLogin: '2024-01-10',
                        status: 'active',
                        joinDate: '2024-01-06'
                    },
                    'user_007': {
                        id: 'user_007',
                        name: 'Odileinis Gibson',
                        title: 'Operations Manager',
                        email: 'odileinis@siegellawgroup.com',
                        avatar: 'https://i.ibb.co/2S8p5z3/avatar.png',
                        department: 'Operations',
                        role: 'user',
                        accessLevel: 'standard',
                        completedItems: [],
                        pinnedItems: [],
                        pathProgress: { 'onboarding_operations': 0 },
                        lastLogin: '2024-01-09',
                        status: 'active',
                        joinDate: '2024-01-05'
                    },
                    'user_008': {
                        id: 'user_008',
                        name: 'Sarah Rivera',
                        title: 'Operations Coordinator',
                        email: 'sarah@siegellawgroup.com',
                        avatar: 'https://i.ibb.co/2S8p5z3/avatar.png',
                        department: 'Operations',
                        role: 'user',
                        accessLevel: 'standard',
                        completedItems: [],
                        pinnedItems: [],
                        pathProgress: { 'onboarding_operations': 0 },
                        lastLogin: '2024-01-08',
                        status: 'active',
                        joinDate: '2024-01-04'
                    },
                    'user_009': {
                        id: 'user_009',
                        name: 'Julie Jordan',
                        title: 'HR Manager',
                        email: 'julie@siegellawgroup.com',
                        avatar: 'https://i.ibb.co/2S8p5z3/avatar.png',
                        department: 'Human Resources',
                        role: 'user',
                        accessLevel: 'standard',
                        completedItems: [],
                        pinnedItems: [],
                        pathProgress: { 'onboarding_human_resources': 0 },
                        lastLogin: '2024-01-07',
                        status: 'active',
                        joinDate: '2024-01-03'
                    }
                },
                // --- CREDENTIALS COLLECTION (Backend Storage) ---
                credentials: {
                    'bsiegel@siegellawgroup.com': {
                        email: 'bsiegel@siegellawgroup.com',
                        passwordHash: 'hashed_siegel', // In real app, this would be bcrypt hash
                        salt: 'salt_barry',
                        lastPasswordChange: '2024-01-01',
                        failedAttempts: 0,
                        lockedUntil: null
                    },
                    'tre@siegellawgroup.com': {
                        email: 'tre@siegellawgroup.com',
                        passwordHash: 'hashed_siegel',
                        salt: 'salt_tre',
                        lastPasswordChange: '2024-01-01',
                        failedAttempts: 0,
                        lockedUntil: null
                    },
                    'abby@siegellawgroup.com': {
                        email: 'abby@siegellawgroup.com',
                        passwordHash: 'hashed_siegel',
                        salt: 'salt_abby',
                        lastPasswordChange: '2024-01-01',
                        failedAttempts: 0,
                        lockedUntil: null
                    },
                    'jay@siegellawgroup.com': {
                        email: 'jay@siegellawgroup.com',
                        passwordHash: 'hashed_siegel',
                        salt: 'salt_jay',
                        lastPasswordChange: '2024-01-01',
                        failedAttempts: 0,
                        lockedUntil: null
                    },
                    'maria@siegellawgroup.com': {
                        email: 'maria@siegellawgroup.com',
                        passwordHash: 'hashed_siegel',
                        salt: 'salt_maria',
                        lastPasswordChange: '2024-01-01',
                        failedAttempts: 0,
                        lockedUntil: null
                    },
                    'jodean@siegellawgroup.com': {
                        email: 'jodean@siegellawgroup.com',
                        passwordHash: 'hashed_siegel',
                        salt: 'salt_jodean',
                        lastPasswordChange: '2024-01-01',
                        failedAttempts: 0,
                        lockedUntil: null
                    },
                    'lennice@siegellawgroup.com': {
                        email: 'lennice@siegellawgroup.com',
                        passwordHash: 'hashed_siegel',
                        salt: 'salt_lennice',
                        lastPasswordChange: '2024-01-01',
                        failedAttempts: 0,
                        lockedUntil: null
                    },
                    'odileinis@siegellawgroup.com': {
                        email: 'odileinis@siegellawgroup.com',
                        passwordHash: 'hashed_siegel',
                        salt: 'salt_odileinis',
                        lastPasswordChange: '2024-01-01',
                        failedAttempts: 0,
                        lockedUntil: null
                    },
                    'sarah@siegellawgroup.com': {
                        email: 'sarah@siegellawgroup.com',
                        passwordHash: 'hashed_siegel',
                        salt: 'salt_sarah',
                        lastPasswordChange: '2024-01-01',
                        failedAttempts: 0,
                        lockedUntil: null
                    },
                    'julie@siegellawgroup.com': {
                        email: 'julie@siegellawgroup.com',
                        passwordHash: 'hashed_siegel',
                        salt: 'salt_julie',
                        lastPasswordChange: '2024-01-01',
                        failedAttempts: 0,
                        lockedUntil: null
                    }
                },
                                    // --- ITEMS COLLECTION (Resources) ---
                    items: {
                        1: { id: 1, department: "Estate Planning", type: "Vision", title: "The Siegel Law Group Vision for Estate Planning", url: "#", description: "Strategic vision document for estate planning services.", author: "Barry D. Siegel, Esq.", lastUpdated: "2024-04-19", skills: ['Estate Planning', 'Strategy'], ratings: [5, 5, 4], comments: [{ user: 'user_123', text: 'Great overview!', date: '2025-08-01' }] },
                        3: { id: 3, department: "Estate Planning", type: "Training", title: "Estate Planning Client Intake Process", url: "https://www.loom.com/share/1bdea97546084986b2b9e15f28e8c0f0", description: "Step-by-step guide for estate planning client intake.", author: "Barry D. Siegel, Esq.", lastUpdated: "2023-01-20", skills: ['Client Intake', 'Estate Planning'], ratings: [5, 4], comments: [] },
                        4: { id: 4, department: "Elder Law", type: "Training", title: "Medicaid Planning Best Practices", url: "https://www.youtube.com/watch?v=dQw4w9WgXcQ", description: "How to effectively plan for Medicaid eligibility.", author: "Maria Siegel", lastUpdated: "2025-08-01", skills: ['Medicaid Planning', 'Elder Law'], ratings: [5, 5, 5, 4], comments: [] },
                        5: { id: 5, department: "Trust Administration", type: "SOP", title: "SOP: Trust Administration Process", url: "#", description: "Standard operating procedure for trust administration.", author: "Jay Silverstein", lastUpdated: "2024-10-21", skills: ['Trust Administration', 'Fiduciary Duties'], ratings: [4], comments: [] },
                        6: { id: 6, department: "Probate", type: "Template", title: "Probate Court Document Templates", url: "#", description: "Template for probate court documents.", author: "Abby L. Steinberg", lastUpdated: "2024-07-03", skills: ['Probate', 'Court Documents'], ratings: [5, 5], comments: [] },
                        7: { id: 7, department: "Attorneys", type: "Training", title: "Legal Research and Case Law Analysis", url: "#", description: "Advanced training on legal research methodologies and case law analysis.", author: "Barry D. Siegel, Esq.", lastUpdated: "2024-03-15", skills: ['Legal Research', 'Case Analysis'], ratings: [5, 4, 5], comments: [] },
                        8: { id: 8, department: "Attorneys", type: "SOP", title: "SOP: Client Communication Protocols", url: "#", description: "Standard operating procedures for attorney-client communication.", author: "Abby L. Steinberg", lastUpdated: "2024-02-28", skills: ['Client Communication', 'Legal Ethics'], ratings: [4, 5], comments: [] },
                        9: { id: 9, department: "Operations", type: "Training", title: "Case Management System Training", url: "#", description: "Comprehensive training on the firm's case management software.", author: "Odileinis Gibson", lastUpdated: "2024-01-10", skills: ['Case Management', 'Software Training'], ratings: [5, 4, 4], comments: [] },
                        10: { id: 10, department: "Operations", type: "SOP", title: "SOP: File Organization and Document Management", url: "#", description: "Standard procedures for organizing client files and managing documents.", author: "Sarah Rivera", lastUpdated: "2024-01-15", skills: ['File Management', 'Documentation'], ratings: [4, 5], comments: [] },
                        11: { id: 11, department: "Human Resources", type: "Training", title: "Employee Onboarding and Training", url: "#", description: "HR processes for onboarding new team members and ongoing training.", author: "Julie Jordan", lastUpdated: "2024-01-05", skills: ['HR Management', 'Training'], ratings: [5, 4], comments: [] },
                        12: { id: 12, department: "Human Resources", type: "SOP", title: "SOP: Performance Review Process", url: "#", description: "Standard operating procedures for employee performance reviews.", author: "Julie Jordan", lastUpdated: "2024-01-20", skills: ['Performance Management', 'HR Processes'], ratings: [4, 4], comments: [] },
                    },
                // --- LEARNING PATHS COLLECTION ---
                paths: {
                    'path_1': { id: 'path_1', title: 'New Estate Planning Attorney Onboarding', description: 'Essential training for all new estate planning attorneys.', department: 'Estate Planning', itemIds: [1, 3] },
                    'path_2': { id: 'path_2', title: 'Advanced Elder Law Tactics', description: 'Level up your elder law and Medicaid planning skills.', department: 'Elder Law', itemIds: [4] }
                },
                // --- MEDIA LIBRARY COLLECTION ---
                mediaLibrary: {
                    // Default media items will be added here
                },
                // --- ONBOARDING PATHS COLLECTION ---
                onboarding: {
                    'onboarding_estate_planning': {
                        id: 'onboarding_estate_planning',
                        title: 'Estate Planning Department Onboarding',
                        description: 'Complete onboarding for new Estate Planning team members',
                        department: 'Estate Planning',
                        itemIds: [1, 3],
                        required: true,
                        estimatedTime: '2 hours'
                    },
                    'onboarding_elder_law': {
                        id: 'onboarding_elder_law',
                        title: 'Elder Law Department Onboarding',
                        description: 'Complete onboarding for new Elder Law team members',
                        department: 'Elder Law',
                        itemIds: [4],
                        required: true,
                        estimatedTime: '3 hours'
                    },
                    'onboarding_medicaid_planning': {
                        id: 'onboarding_medicaid_planning',
                        title: 'Medicaid Planning Department Onboarding',
                        description: 'Complete onboarding for new Medicaid Planning team members',
                        department: 'Medicaid Planning',
                        itemIds: [4],
                        required: true,
                        estimatedTime: '2 hours'
                    },
                    'onboarding_attorneys': {
                        id: 'onboarding_attorneys',
                        title: 'Attorneys Department Onboarding',
                        description: 'Complete onboarding for new attorneys',
                        department: 'Attorneys',
                        itemIds: [7, 8],
                        required: true,
                        estimatedTime: '3 hours'
                    },
                    'onboarding_operations': {
                        id: 'onboarding_operations',
                        title: 'Operations Department Onboarding',
                        description: 'Complete onboarding for new operations team members',
                        department: 'Operations',
                        itemIds: [9, 10],
                        required: true,
                        estimatedTime: '2.5 hours'
                    },
                    'onboarding_human_resources': {
                        id: 'onboarding_human_resources',
                        title: 'Human Resources Department Onboarding',
                        description: 'Complete onboarding for new HR team members',
                        department: 'Human Resources',
                        itemIds: [11, 12],
                        required: true,
                        estimatedTime: '2 hours'
                    },
                    'onboarding_sales': {
                        id: 'onboarding_sales',
                        title: 'Sales Department Onboarding',
                        description: 'Complete onboarding for new Sales team members',
                        department: 'Sales',
                        itemIds: [1, 3],
                        required: true,
                        estimatedTime: '2.5 hours'
                    }
                },
                // --- CRM CURRICULA by department (Intake, Sales, Attorneys, etc.) ---
                crmCurricula: {},
                // --- PLATFORM SETTINGS (admin-configured) ---
                settings: {
                    platformCrm: null,
                    companyName: '',
                    practiceArea: '',
                    showIndustryUpdates: true,
                    specialistStyle: 'detailed',
                    welcomeLine: ''
                }
            };

            // Practice areas for Industry Updates and AI personalization
            const PRACTICE_AREAS = [
                { id: 'estate_elder', name: 'Estate Planning & Elder Law' },
                { id: 'estate_planning', name: 'Estate Planning' },
                { id: 'elder_law', name: 'Elder Law' },
                { id: 'medicaid', name: 'Medicaid Planning' },
                { id: 'trust_probate', name: 'Trust & Probate' },
                { id: 'general_legal', name: 'General Law Practice' }
            ];

            // Departments that can have CRM curricula (for "curriculums by department")
            const CRM_DEPARTMENTS = [
                { id: 'intake', name: 'Intake', description: 'Client intake and first touch' },
                { id: 'sales', name: 'Sales', description: 'Pipeline and deal management' },
                { id: 'attorneys', name: 'Attorneys', description: 'Case and matter management' },
                { id: 'operations', name: 'Operations', description: 'Process and workflow' },
                { id: 'marketing', name: 'Marketing', description: 'Leads and campaigns' }
            ];

            // Popular CRMs with links to their academies/help centers (for training resources)
            const POPULAR_CRMS = [
                { id: 'hubspot', name: 'HubSpot', academyUrl: 'https://academy.hubspot.com/', helpUrl: 'https://academy.hubspot.com/lessons/setting-up-your-crm', icon: 'layout-grid' },
                { id: 'salesforce', name: 'Salesforce', academyUrl: 'https://trailhead.salesforce.com/', helpUrl: 'https://help.salesforce.com/', icon: 'cloud' },
                { id: 'zoho', name: 'Zoho CRM', academyUrl: 'https://www.zoho.com/crm/help/', helpUrl: 'https://www.zoho.com/crm/help/getting-started.html', icon: 'box' },
                { id: 'pipedrive', name: 'Pipedrive', academyUrl: 'https://support.pipedrive.com/', helpUrl: 'https://support.pipedrive.com/en/article/getting-started-with-pipedrive', icon: 'trending-up' },
                { id: 'monday', name: 'Monday Sales CRM', academyUrl: 'https://support.monday.com/', helpUrl: 'https://support.monday.com/hc/en-us/articles/360001139483-Getting-started-with-monday-sales-CRM', icon: 'calendar' },
                { id: 'freshsales', name: 'Freshsales', academyUrl: 'https://www.freshworks.com/support/', helpUrl: 'https://support.freshworks.com/support/solutions/folders/50000000065', icon: 'users' },
                { id: 'copper', name: 'Copper (Google)', academyUrl: 'https://support.copper.com/', helpUrl: 'https://support.copper.com/hc/en-us/categories/360002396554-Getting-Started', icon: 'database' },
                { id: 'insightly', name: 'Insightly', academyUrl: 'https://support.insightly.com/', helpUrl: 'https://support.insightly.com/hc/en-us/articles/360040516633-Getting-Started', icon: 'link' }
            ];

            // Gemini API for AI recommendations. For production: use a backend or restrict key in Google Cloud Console.
            const GEMINI_API_KEY = 'AIzaSyB6H1BJKmKX6Ft2GH--MkjB4U-qGzh5qL4';

            // =================================================================================
            // FIREBASE DATA PERSISTENCE FUNCTIONS
            // =================================================================================
            async function saveToFirebase(collection, data) {
                // Validate data before saving
                if (!data) {
                    console.error(`‚ùå Cannot save null/undefined data for collection: ${collection}`);
                    return false;
                }
                
                // ALWAYS save to localStorage as backup first
                try {
                    localStorage.setItem(`tslg_${collection}`, JSON.stringify(data));
                    console.log(`‚úÖ Saved to localStorage: ${collection}`);
                } catch (localError) {
                    console.error(`‚ùå Error saving to localStorage: ${collection}`, localError);
                }
                
                // Wait for Firebase to be ready
                let retryCount = 0;
                const maxRetries = 3;
                
                while (retryCount < maxRetries) {
                    try {
                        if (window.firebaseDb) {
                            const { doc, setDoc } = await import('https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js');
                            await setDoc(doc(window.firebaseDb, collection, 'main'), data);
                            console.log(`‚úÖ Saved to Firebase: ${collection} (attempt ${retryCount + 1})`);
                            return true;
                        } else {
                            console.log('‚ö†Ô∏è Firebase not available, using localStorage only');
                            return false;
                        }
                    } catch (error) {
                        retryCount++;
                        console.error(`‚ùå Error saving to Firebase: ${collection} (attempt ${retryCount}/${maxRetries})`, error);
                        
                        if (retryCount >= maxRetries) {
                            console.log('‚úÖ Data still saved to localStorage as backup');
                            return false;
                        }
                        
                        // Wait before retry
                        await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
                    }
                }
                
                return false;
            }
            
            async function loadFromFirebase(collection) {
                // First try localStorage (most reliable)
                try {
                    const localData = localStorage.getItem(`tslg_${collection}`);
                    if (localData) {
                        const parsedData = JSON.parse(localData);
                        console.log(`‚úÖ Loaded from localStorage: ${collection}`);
                        return parsedData;
                    }
                } catch (localError) {
                    console.error(`‚ùå Error loading from localStorage: ${collection}`, localError);
                }
                
                // Then try Firebase
                try {
                    if (window.firebaseDb) {
                        const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js');
                        const docRef = doc(window.firebaseDb, collection, 'main');
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            console.log(`‚úÖ Loaded from Firebase: ${collection}`);
                            const data = docSnap.data();
                            
                            // Validate data structure
                            if (data && typeof data === 'object') {
                                // Save to localStorage for future use
                                try {
                                    localStorage.setItem(`tslg_${collection}`, JSON.stringify(data));
                                } catch (saveError) {
                                    console.error(`‚ùå Error saving to localStorage: ${collection}`, saveError);
                                }
                                return data;
                            } else {
                                console.error(`‚ùå Invalid data structure for: ${collection}`, data);
                                return null;
                            }
                        }
                    }
                } catch (error) {
                    console.error(`‚ùå Error loading from Firebase: ${collection}`, error);
                }
                
                console.log(`‚ö†Ô∏è No data found for: ${collection}`);
                return null;
            }
            
            async function callGemini(prompt) {
                try {
                    const res = await fetch(`https://generativeai.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ role: 'user', parts: [{ text: prompt }] }],
                            generationConfig: { temperature: 0.7, maxOutputTokens: 2048 }
                        })
                    });
                    if (!res.ok) throw new Error(await res.text());
                    const data = await res.json();
                    const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
                    return text || '';
                } catch (err) {
                    console.error('Gemini API error:', err);
                    return '';
                }
            }

            /** Call Gemini with Google Search grounding for real-time web/trends. Tries primary then backup endpoint. */
            async function callGeminiWithSearch(prompt) {
                const body = {
                    contents: [{ role: 'user', parts: [{ text: prompt }] }],
                    tools: [{ google_search: {} }],
                    generationConfig: { temperature: 0.5, maxOutputTokens: 2048 }
                };
                const endpoints = [
                    `https://generativeai.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`,
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`
                ];
                for (const url of endpoints) {
                    try {
                        const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                        if (!res.ok) throw new Error(await res.text());
                        const data = await res.json();
                        const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text && text.trim()) return text.trim();
                    } catch (err) {
                        console.warn('Gemini with Search try failed:', err);
                    }
                }
                return '';
            }

            function getCompanyName() {
                return (db.settings && db.settings.companyName) ? db.settings.companyName.trim() : 'The Siegel Law Group Academy';
            }

            function getPracticeAreaLabel() {
                const id = (db.settings && db.settings.practiceArea) || '';
                if (!id) return 'Estate Planning, Elder Law, and impact on our practice.';
                const area = PRACTICE_AREAS.find(a => a.id === id);
                return area ? `${area.name} and impact on our practice.` : 'Relevant updates for our practice.';
            }

            function getPracticeAreaForPrompt() {
                const id = (db.settings && db.settings.practiceArea) || '';
                if (!id) return 'Estate Planning and Elder Law';
                const area = PRACTICE_AREAS.find(a => a.id === id);
                return area ? area.name : 'Estate Planning and Elder Law';
            }

            /** Build business context from Settings for AI (updates, trends, training). Use this so AI pulls relevant content. */
            function getBusinessContextForAI() {
                const s = db.settings || {};
                const parts = [];
                if (s.companyName && s.companyName.trim()) parts.push(`Business name: ${s.companyName.trim()}`);
                if (s.companyWebsite && s.companyWebsite.trim()) parts.push(`Website: ${s.companyWebsite.trim()}`);
                const practiceLabel = getPracticeAreaForPrompt();
                parts.push(`Practice area: ${practiceLabel}`);
                if (s.servicesProducts && s.servicesProducts.trim()) parts.push(`Services/products: ${s.servicesProducts.trim()}`);
                if (s.competitors && s.competitors.trim()) parts.push(`Competitors (for context): ${s.competitors.trim()}`);
                return parts.length ? parts.join('. ') : `Practice area: ${practiceLabel}`;
            }

            function updateDocumentTitle() {
                const name = getCompanyName();
                const title = name ? `${name} | Training Hub` : 'Training Hub';
                try { document.title = title; } catch (_) {}
                const loginTitleEl = document.getElementById('login-modal-title');
                if (loginTitleEl) loginTitleEl.textContent = name ? `Login to ${name}` : 'Login to Training Academy';
            }

            function getCrmCurriculumContext() {
                const curricula = db.crmCurricula || {};
                const parts = [];
                CRM_DEPARTMENTS.forEach(dept => {
                    const items = (curricula[dept.id] && curricula[dept.id].items) || [];
                    if (!items.length) return;
                    parts.push(`\n--- ${dept.name} ---`);
                    items.forEach(it => {
                        parts.push(`Title: ${it.title}`);
                        if (it.description) parts.push(`Description: ${it.description}`);
                        if (it.url) parts.push(`URL: ${it.url}`);
                        if (it.steps && it.steps.length) it.steps.forEach(s => parts.push(`Step ${s.stepNumber}: ${typeof s === 'object' && s.instruction ? s.instruction : s}`));
                    });
                });
                return parts.length ? parts.join('\n') : '(No curriculum items yet.)';
            }
            
            async function initializeData() {
                try {
                    // Load data from Firebase with fallback to default data
                    const firebaseUsers = await loadFromFirebase('users');
                    const firebaseItems = await loadFromFirebase('items');
                    const firebaseOnboarding = await loadFromFirebase('onboarding');
                    const firebaseCredentials = await loadFromFirebase('credentials');
                    const firebaseMediaLibrary = await loadFromFirebase('mediaLibrary');
                    const firebaseCrmCurricula = await loadFromFirebase('crmCurricula');
                    const firebaseSettings = await loadFromFirebase('settings');
                    
                    console.log('Firebase data loaded:', {
                        users: !!firebaseUsers,
                        items: !!firebaseItems,
                        onboarding: !!firebaseOnboarding,
                        credentials: !!firebaseCredentials,
                        mediaLibrary: !!firebaseMediaLibrary,
                        crmCurricula: !!firebaseCrmCurricula,
                        settings: !!firebaseSettings
                    });
                    
                    // Use Firebase data if available, otherwise use default data
                    if (firebaseUsers && typeof firebaseUsers === 'object') db.users = firebaseUsers;
                    if (firebaseItems && typeof firebaseItems === 'object') db.items = firebaseItems;
                    if (firebaseOnboarding && typeof firebaseOnboarding === 'object') db.onboarding = firebaseOnboarding;
                    if (firebaseCredentials && typeof firebaseCredentials === 'object') db.credentials = firebaseCredentials;
                    if (firebaseMediaLibrary && typeof firebaseMediaLibrary === 'object') db.mediaLibrary = firebaseMediaLibrary;
                    if (firebaseCrmCurricula && typeof firebaseCrmCurricula === 'object') db.crmCurricula = firebaseCrmCurricula;
                    if (firebaseSettings && typeof firebaseSettings === 'object') db.settings = firebaseSettings;
                    
                    // Ensure all collections exist
                    if (!db.users) db.users = {};
                    if (!db.items) db.items = {};
                    if (!db.onboarding) db.onboarding = {};
                    if (!db.credentials) db.credentials = {};
                    if (!db.mediaLibrary) db.mediaLibrary = {};
                    if (!db.crmCurricula) db.crmCurricula = {};
                    if (!db.settings) db.settings = { platformCrm: null };
                    
                    console.log('Data initialized from Firebase');
                    console.log('Current onboarding data:', db.onboarding);
                    console.log('Current media library data:', db.mediaLibrary);
                    console.log('Data validation complete - all collections exist');
                } catch (error) {
                    console.error('Error initializing data:', error);
                }
            }
            
            // Initialize data when Firebase is ready
            window.addEventListener('firebase-ready', async () => {
                console.log('Firebase ready event triggered');
                await initializeData();
                updateDocumentTitle();
                // Save initial data to Firebase if it doesn't exist
                try {
                    const itemsData = await loadFromFirebase('items');
                    const onboardingData = await loadFromFirebase('onboarding');
                    const mediaLibraryData = await loadFromFirebase('mediaLibrary');
                    
                    if (!itemsData) {
                        console.log('Saving initial items data to Firebase...');
                        await saveToFirebase('items', db.items);
                    }
                    
                    if (!onboardingData) {
                        console.log('Saving initial onboarding data to Firebase...');
                        await saveToFirebase('onboarding', db.onboarding);
                    }
                    
                    if (!mediaLibraryData) {
                        console.log('Saving initial media library data to Firebase...');
                        await saveToFirebase('mediaLibrary', db.mediaLibrary);
                    }
                } catch (error) {
                    console.error('Error saving initial data:', error);
                }
                
                // Check for existing login state
                checkExistingLogin();
            });
            
            // Fallback initialization if Firebase doesn't load within 3 seconds
            setTimeout(() => {
                if (!window.firebaseDb) {
                    console.log('Firebase not available, using localStorage fallback');
                    checkExistingLogin();
                }
            }, 3000);
            
            // Render avatar media library for selection
            function renderAvatarMediaLibrary() {
                const mediaGrid = document.getElementById('avatar-media-grid');
                const noResults = document.getElementById('avatar-no-results');
                const searchInput = document.getElementById('avatar-search');
                const filterSelect = document.getElementById('avatar-filter');
                
                if (!db.mediaLibrary) {
                    db.mediaLibrary = {};
                }
                
                // Get all image media
                let imageMedia = Object.values(db.mediaLibrary).filter(media => 
                    media.type === 'image' || 
                    media.url.match(/\.(jpg|jpeg|png|gif|webp)$/i) ||
                    media.url.startsWith('data:image/')
                );
                
                // Apply search filter
                const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                if (searchTerm) {
                    imageMedia = imageMedia.filter(media => 
                        media.title.toLowerCase().includes(searchTerm) ||
                        media.description.toLowerCase().includes(searchTerm)
                    );
                }
                
                // Apply type filter
                const filterType = filterSelect ? filterSelect.value : '';
                if (filterType) {
                    imageMedia = imageMedia.filter(media => {
                        if (media.url.startsWith('data:')) {
                            return media.url.startsWith(filterType);
                        }
                        return media.url.toLowerCase().includes(filterType.split('/')[1]);
                    });
                }
                
                if (imageMedia.length === 0) {
                    mediaGrid.innerHTML = '';
                    noResults.classList.remove('hidden');
                    return;
                }
                
                noResults.classList.add('hidden');
                mediaGrid.innerHTML = imageMedia.map(media => `
                    <div class="bg-white border border-slate-200 rounded-lg p-3 hover:border-[var(--tnt-pink)] cursor-pointer transition-colors" 
                         data-media-id="${media.id}" 
                         data-media-url="${media.url}"
                         data-media-title="${media.title}">
                        <div class="aspect-square bg-slate-100 rounded-lg overflow-hidden mb-2">
                            <img src="${media.url}" alt="${media.title}" class="w-full h-full object-cover">
                        </div>
                        <div class="text-xs">
                            <div class="font-medium text-slate-900 truncate">${media.title}</div>
                            <div class="text-slate-500 text-xs">${media.type}</div>
                        </div>
                    </div>
                `).join('');
                
                // Add click handlers
                mediaGrid.querySelectorAll('[data-media-id]').forEach(item => {
                    item.addEventListener('click', function() {
                        const mediaId = this.dataset.mediaId;
                        const mediaUrl = this.dataset.mediaUrl;
                        const mediaTitle = this.dataset.mediaTitle;
                        
                        // Update the avatar preview
                        const avatarPreview = document.getElementById('edit-member-avatar-preview');
                        if (avatarPreview) {
                            avatarPreview.src = mediaUrl;
                        }
                        
                        // Store selected media for form submission
                        window.selectedAvatarMedia = {
                            id: mediaId,
                            url: mediaUrl,
                            title: mediaTitle
                        };
                        
                        // Clear the file input
                        const fileInput = document.getElementById('edit-member-avatar');
                        if (fileInput) {
                            fileInput.value = '';
                        }
                        
                        // Close modal
                        hideModal('select-avatar-modal');
                        showNotification(`Selected "${mediaTitle}" as profile picture`, 'success');
                    });
                });
                
                lucide.createIcons();
            }
            
            // Recovery function for lost media library data
            window.recoverMediaLibrary = function() {
                console.log('üîÑ Attempting to recover media library data...');
                try {
                    // Check localStorage for media library data
                    const localMediaLibrary = localStorage.getItem('tslg_mediaLibrary');
                    if (localMediaLibrary) {
                        const recoveredData = JSON.parse(localMediaLibrary);
                        console.log('Found media library data in localStorage:', recoveredData);
                        
                        // Merge with current data
                        if (!db.mediaLibrary) db.mediaLibrary = {};
                        Object.assign(db.mediaLibrary, recoveredData);
                        
                        // Save to Firebase
                        saveToFirebase('mediaLibrary', db.mediaLibrary);
                        
                        // Re-render
                        render();
                        showNotification('Media library data recovered!', 'success');
                        return true;
                    } else {
                        console.log('No media library data found in localStorage');
                        showNotification('No media library data to recover', 'info');
                        return false;
                    }
                } catch (error) {
                    console.error('Error recovering media library:', error);
                    showNotification('Failed to recover media library data', 'error');
                    return false;
                }
            };
            
            // Data integrity check function
            window.checkDataIntegrity = function() {
                console.log('üîç Checking data integrity...');
                const issues = [];
                
                // Check if all collections exist
                const collections = ['users', 'items', 'onboarding', 'credentials', 'mediaLibrary', 'crmCurricula', 'settings'];
                collections.forEach(collection => {
                    if (!db[collection]) {
                        issues.push(`Missing collection: ${collection}`);
                        db[collection] = {};
                    } else if (typeof db[collection] !== 'object') {
                        issues.push(`Invalid collection type: ${collection} (${typeof db[collection]})`);
                        db[collection] = {};
                    }
                });
                
                // Check for null/undefined values in items
                if (db.items) {
                    Object.keys(db.items).forEach(itemId => {
                        const item = db.items[itemId];
                        if (!item || typeof item !== 'object') {
                            issues.push(`Invalid item: ${itemId}`);
                            delete db.items[itemId];
                        }
                    });
                }
                
                // Check for null/undefined values in media library
                if (db.mediaLibrary) {
                    Object.keys(db.mediaLibrary).forEach(mediaId => {
                        const media = db.mediaLibrary[mediaId];
                        if (!media || typeof media !== 'object') {
                            issues.push(`Invalid media: ${mediaId}`);
                            delete db.mediaLibrary[mediaId];
                        }
                    });
                }
                
                if (issues.length > 0) {
                    console.warn('‚ö†Ô∏è Data integrity issues found:', issues);
                    showNotification(`Found ${issues.length} data integrity issues`, 'warning');
                    return false;
                } else {
                    console.log('‚úÖ Data integrity check passed');
                    showNotification('Data integrity check passed', 'success');
                    return true;
                }
            };
            
            // Manual data sync function (for debugging)
            window.syncDataToFirebase = async function() {
                console.log('üîÑ Manual data sync to Firebase...');
                try {
                    await saveToFirebase('items', db.items);
                    await saveToFirebase('users', db.users);
                    await saveToFirebase('onboarding', db.onboarding);
                    await saveToFirebase('credentials', db.credentials);
                    await saveToFirebase('mediaLibrary', db.mediaLibrary);
                    await saveToFirebase('crmCurricula', db.crmCurricula);
                    await saveToFirebase('settings', db.settings);
                    console.log('‚úÖ Manual sync complete!');
                    alert('Data synced to Firebase successfully!');
                } catch (error) {
                    console.error('‚ùå Manual sync failed:', error);
                    alert('Sync failed, but data is saved locally');
                }
            };
            
            // File upload functions
            async function uploadFile(file, folder) {
                try {
                    console.log('=== FILE UPLOAD START ===');
                    console.log('File:', file.name, 'Size:', file.size, 'Type:', file.type);
                    console.log('Firebase Storage available:', !!window.firebaseStorage);
                    console.log('Firebase Storage object:', window.firebaseStorage);
                    
                    if (!window.firebaseStorage) {
                        throw new Error('Firebase Storage not initialized');
                    }
                    
                    // Show upload progress modal
                    showUploadProgress(file.name);
                    
                    const timestamp = Date.now();
                    const fileName = `${folder}/${timestamp}_${file.name}`;
                    
                    console.log('üì§ Creating storage reference for:', fileName);
                    const storageRef = ref(window.firebaseStorage, fileName);
                    console.log('Storage reference created:', storageRef);
                    
                    // Simulate progress updates (Firebase doesn't provide real progress)
                    const progressInterval = setInterval(() => {
                        updateUploadProgress(Math.random() * 30 + 10); // Random progress between 10-40%
                    }, 500);
                    
                    console.log('üì§ Starting upload...');
                    const snapshot = await uploadBytes(storageRef, file);
                    console.log('Upload snapshot:', snapshot);
                    
                    clearInterval(progressInterval);
                    updateUploadProgress(90); // Almost done
                    
                    console.log('üì§ Getting download URL...');
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    console.log('‚úÖ File uploaded successfully:', downloadURL);
                    
                    updateUploadProgress(100); // Complete
                    setTimeout(() => {
                        hideUploadProgress();
                    }, 500);
                    
                    return downloadURL;
                } catch (error) {
                    console.error('‚ùå File upload failed:', error);
                    console.error('Error details:', {
                        message: error.message,
                        code: error.code,
                        stack: error.stack,
                        name: error.name
                    });
                    hideUploadProgress();
                    
                    // Provide more specific error messages
                    let errorMessage = 'Upload failed';
                    if (error.code === 'storage/unauthorized') {
                        errorMessage = 'Upload failed: Unauthorized access to storage';
                    } else if (error.code === 'storage/quota-exceeded') {
                        errorMessage = 'Upload failed: Storage quota exceeded';
                    } else if (error.code === 'storage/unauthenticated') {
                        errorMessage = 'Upload failed: Authentication required';
                    } else if (error.message) {
                        errorMessage = `Upload failed: ${error.message}`;
                    }
                    
                    throw new Error(errorMessage);
                }
            }
            
            // Upload progress functions
            function showUploadProgress(filename) {
                document.getElementById('upload-filename').textContent = filename;
                document.getElementById('upload-percentage').textContent = '0%';
                document.getElementById('upload-progress-bar').style.width = '0%';
                document.getElementById('upload-status').textContent = 'Preparing upload...';
                document.getElementById('upload-time-estimate').textContent = 'Please wait...';
                showModal('upload-progress-modal');
            }
            
            function updateUploadProgress(percentage) {
                document.getElementById('upload-percentage').textContent = `${Math.round(percentage)}%`;
                document.getElementById('upload-progress-bar').style.width = `${percentage}%`;
                
                if (percentage < 30) {
                    document.getElementById('upload-status').textContent = 'Uploading file...';
                    document.getElementById('upload-time-estimate').textContent = 'This may take a few moments';
                } else if (percentage < 70) {
                    document.getElementById('upload-status').textContent = 'Processing file...';
                    document.getElementById('upload-time-estimate').textContent = 'Almost done...';
                } else if (percentage < 100) {
                    document.getElementById('upload-status').textContent = 'Finalizing upload...';
                    document.getElementById('upload-time-estimate').textContent = 'Just a moment...';
                } else {
                    document.getElementById('upload-status').textContent = 'Upload complete!';
                    document.getElementById('upload-time-estimate').textContent = 'File uploaded successfully';
                }
            }
            
            function hideUploadProgress() {
                hideModal('upload-progress-modal');
            }
            
            // Base64 fallback function
            function fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            }
            
            // Preview image function
            function previewImage(input, previewId) {
                const file = input.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById(previewId).src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            // Check for existing login state
            function checkExistingLogin() {
                const loginState = localStorage.getItem('tslg_login_state');
                if (loginState) {
                    try {
                        const { email, timestamp } = JSON.parse(loginState);
                        
                        // Check if login is still valid (24 hours)
                        const loginAge = Date.now() - timestamp;
                        const maxAge = 24 * 60 * 60 * 1000; // 24 hours
                        
                        if (loginAge < maxAge) {
                            // Find user by email
                            const user = Object.values(db.users).find(u => u.email === email);
                            if (user) {
                                appState.currentUser = user;
                                appState.isAuthenticated = true;
                                render();
                                console.log('Auto-login successful for:', user.name);
                            }
                        } else {
                            // Login expired, clear it
                            localStorage.removeItem('tslg_login_state');
                            console.log('Login expired, cleared from localStorage');
                        }
                    } catch (error) {
                        console.error('Error parsing login state:', error);
                        localStorage.removeItem('tslg_login_state');
                    }
                }
            }
            
            // =================================================================================
            // STATE MANAGEMENT
            // =================================================================================
            const appState = {
                currentUser: null, // Will be set after login
                isAuthenticated: false,
                currentView: 'dashboard', // 'dashboard', 'department', 'paths', 'item', 'onboarding'
                activeDepartment: null,
                activePathId: null,
                activeItemId: null,
                searchQuery: '',
                sortBy: '',
                currentDepartment: null, // For reorder functionality
                showLoginModal: false,
                selectedCrmId: null,
                crmBuilderDeptId: null,
                crmBuilderDeptName: null,
                crmBuilderPendingItems: []
            };

            // =================================================================================
            // RENDER ENGINE
            // =================================================================================
            function render() {
                renderSidebar();
                renderMainContent();
                lucide.createIcons();
                if (appState.currentView === 'dashboard') {
                    setTimeout(() => loadIndustryUpdates(), 0);
                    setTimeout(() => loadFeaturedRead(), 200);
                }
            }
            
            function getIndustryUpdatesFallbackBullets() {
                const practiceLabel = getPracticeAreaForPrompt();
                return [
                    'Legislative and regulatory changes in ' + practiceLabel.toLowerCase(),
                    'NAELA, AARP, and state bar association updates',
                    'Trust and estate tax law developments',
                    'Medicaid and long-term care policy trends',
                    'CLE and professional development opportunities',
                    'Client communication and technology best practices'
                ];
            }

            async function loadIndustryUpdates() {
                const el = document.getElementById('industry-updates-content');
                const btn = document.getElementById('refresh-industry-updates');
                if (!el) return;
                if (btn) btn.disabled = true;
                el.innerHTML = '<p class="text-slate-500">Loading trends and industry updates...</p>';
                const businessContext = getBusinessContextForAI();
                const practiceLabel = getPracticeAreaForPrompt();
                const prompt = `You are a research assistant. Use web search to find real recent articles, blogs, and headlines.

Business profile: ${businessContext}

Search the web for:
1) Recent articles or blog posts (from NAELA, AARP, ABA, state bars, Law360, WealthManagement.com, elder law/estate planning outlets) relevant to ${practiceLabel}.
2) Trending topics or news that impact this type of practice.

Reply with 5‚Äì7 short bullet points. For each bullet: mention a specific article title, report, or headline when you find one, and the source name (e.g. "NAELA: ..." or "Law360 reports ..."). If you cannot find a specific article, give the topic and suggest they search for it. Be current and specific. No intro or outro‚Äîonly the bullet list.`;
                let text = await callGeminiWithSearch(prompt);
                if (!text || !text.trim()) {
                    text = await callGemini(`Business context: "${businessContext}". List 5‚Äì6 current topics for their practice: recent articles/themes from NAELA, ABA, state bars, Law360, Medicaid/trust updates. One short bullet per line. No intro.`);
                }
                if (el) {
                    if (text && text.trim()) {
                        const bullets = text.split(/\n/).filter(l => l.trim()).slice(0, 8);
                        el.innerHTML = bullets.map(l => `<p class="text-slate-700">‚Ä¢ ${l.replace(/^[\s\-‚Ä¢*]+/, '').trim()}</p>`).join('');
                    } else {
                        const fallback = getIndustryUpdatesFallbackBullets();
                        el.innerHTML = '<p class="text-slate-500 mb-2">Live updates could not be loaded. Areas to watch:</p>' + fallback.map(b => `<p class="text-slate-700">‚Ä¢ ${b}</p>`).join('');
                    }
                }
                if (btn) btn.disabled = false;
            }

            async function loadFeaturedRead() {
                const el = document.getElementById('featured-read-content');
                const btn = document.getElementById('refresh-featured-read');
                if (!el) return;
                if (btn) btn.disabled = true;
                el.innerHTML = '<p class="text-slate-500">Finding today\'s featured read...</p>';
                const businessContext = getBusinessContextForAI();
                const practiceLabel = getPracticeAreaForPrompt();
                const prompt = `Using web search, find the single most influential or impactful recent article, blog post, or report (from the last few months) for a ${practiceLabel} practice. Business context: ${businessContext}. Prefer: NAELA, ABA, state bar, Law360, WealthManagement.com, AARP, or reputable legal/estate planning sources. Reply with ONLY a valid JSON object, no other text: {"title":"Article or post title","source":"Publication or site name","url":"https://...","why":"One sentence on why this matters for this practice."}. If you cannot find a real article with a URL, use {"title":"","source":"","url":"","why":""}.`;
                let text = await callGeminiWithSearch(prompt);
                if (!text || !text.trim()) text = await callGemini(prompt);
                let featured = null;
                if (text && text.trim()) {
                    try {
                        const raw = text.replace(/```json?\s*|\s*```/g, '').trim();
                        featured = JSON.parse(raw);
                    } catch (_) {
                        featured = null;
                    }
                }
                if (el) {
                    if (featured && featured.title && (featured.url || featured.source || featured.why)) {
                        const link = featured.url && featured.url.startsWith('http') ? `<a href="${featured.url.replace(/"/g, '&quot;')}" target="_blank" rel="noopener" class="font-semibold text-[var(--tnt-pink)] hover:underline">${escapeAttr(featured.title)}</a>` : `<span class="font-semibold text-slate-800">${escapeAttr(featured.title)}</span>`;
                        const source = featured.source ? ` <span class="text-slate-500">‚Äî ${escapeAttr(featured.source)}</span>` : '';
                        const why = featured.why ? `<p class="mt-2 text-slate-600">${escapeAttr(featured.why)}</p>` : '';
                        el.innerHTML = `<p>${link}${source}</p>${why}`;
                    } else {
                        const fallbackTopics = getIndustryUpdatesFallbackBullets().slice(0, 2);
                        el.innerHTML = '<p class="text-slate-500">Featured read could not be loaded right now.</p><p class="text-slate-600 mt-2">Try searching for: ' + escapeAttr(fallbackTopics.join('; ')) + '</p>';
                    }
                }
                if (btn) btn.disabled = false;
            }

            function renderSidebar() {
                const nav = document.getElementById('main-nav');
                const departments = [...new Set(Object.values(db.items).map(i => i.department))];
                
                const navLinks = [
                    { id: 'dashboard', icon: 'layout-dashboard', label: 'Dashboard' },
                    { id: 'onboarding', icon: 'graduation-cap', label: 'Onboarding' },
                    { id: 'paths', icon: 'git-merge', label: 'Learning Paths' },
                    { id: 'crm', icon: 'layout-grid', label: 'CRM' },
                    ...departments.map(d => ({ id: `dept-${d}`, icon: getIconForDept(d), label: d }))
                ];
                
                // Add admin/creator only tabs
                if (appState.currentUser && (appState.currentUser.accessLevel === 'admin' || appState.currentUser.role === 'creator')) {
                    navLinks.push({ id: 'media-library', icon: 'image', label: 'Media Library' });
                    navLinks.push({ id: 'members', icon: 'users', label: 'Members' });
                    navLinks.push({ id: 'curriculum', icon: 'book-open', label: 'Curriculum Creator' });
                    navLinks.push({ id: 'settings', icon: 'settings', label: 'Settings' });
                }

                nav.innerHTML = navLinks.map(link => `
                    <a href="#" class="sidebar-link flex items-center px-4 py-2.5 text-sm font-medium rounded-md text-slate-600 hover:bg-slate-100" data-view="${link.id.startsWith('dept-') ? 'department' : link.id}" data-dept="${link.id.startsWith('dept-') ? link.label : ''}">
                        <span data-lucide="${link.icon}" class="w-5 h-5 mr-3"></span>
                        ${link.label}
                    </a>
                `).join('');

                // Highlight active link
                document.querySelectorAll('.sidebar-link').forEach(link => {
                    const isDeptActive = appState.currentView === 'department' && link.dataset.dept === appState.activeDepartment;
                    const isViewActive = appState.currentView === link.dataset.view && !isDeptActive;
                    link.classList.toggle('active', isDeptActive || isViewActive);
                });
                
                // Render User Profile
                const userProfile = document.getElementById('user-profile');
                if (appState.isAuthenticated && appState.currentUser) {
                    userProfile.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <img src="${appState.currentUser.avatar}" alt="User Avatar" class="w-10 h-10 rounded-full">
                                <div class="ml-3">
                                    <p class="font-semibold text-sm">${appState.currentUser.name}</p>
                                    <p class="text-xs text-slate-500">${appState.currentUser.title}</p>
                                </div>
                            </div>
                            ${appState.currentUser.role === 'admin' || appState.currentUser.role === 'creator' ? `
                                <button id="admin-btn" class="text-slate-400 hover:text-slate-600">
                                    <span data-lucide="settings" class="w-5 h-5"></span>
                                </button>
                            ` : ''}
                        </div>
                        <button id="logout-btn" class="w-full mt-3 text-xs text-slate-500 hover:text-slate-700 text-left">
                            Logout
                        </button>
                    `;
                } else {
                    userProfile.innerHTML = `
                        <button id="login-btn" class="w-full text-left">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-slate-200 rounded-full flex items-center justify-center">
                                    <span data-lucide="user" class="w-5 h-5 text-slate-400"></span>
                                </div>
                                <div class="ml-3">
                                    <p class="font-semibold text-sm text-slate-700">Click to Login</p>
                                    <p class="text-xs text-slate-500">Access your progress</p>
                                </div>
                            </div>
                        </button>
                    `;
                }
            }

            function renderMainContent() {
                const container = document.getElementById('main-content');
                // Clear previous content
                container.innerHTML = '';

                if (!appState.isAuthenticated) {
                    const companyName = getCompanyName();
                    const welcomeLine = (db.settings && db.settings.welcomeLine) ? db.settings.welcomeLine.trim() : 'Please login to access your training resources and track your progress.';
                    container.innerHTML = `
                        <div class="flex items-center justify-center h-full">
                            <div class="text-center">
                                <h1 class="text-3xl font-bold text-slate-900 mb-4">Welcome to ${companyName || 'Training Academy'}</h1>
                                <p class="text-slate-600 mb-8">${welcomeLine}</p>
                                <button id="login-prompt-btn" class="bg-[var(--tnt-pink)] text-white px-6 py-3 rounded-lg font-medium hover:bg-[#d6005b] transition-colors">
                                    Login to Continue
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }

                switch (appState.currentView) {
                    case 'dashboard':
                        container.innerHTML = renderDashboard();
                        break;
                    case 'onboarding':
                        container.innerHTML = renderOnboarding();
                        break;
                    case 'onboarding-curriculum':
                        container.innerHTML = renderOnboardingCurriculum();
                        break;
                    case 'members':
                        container.innerHTML = renderMembers();
                        break;
                    case 'media-library':
                        container.innerHTML = renderMediaLibrary();
                        break;
                    case 'crm':
                        container.innerHTML = renderCRM();
                        break;
                    case 'settings':
                        container.innerHTML = renderSettings();
                        break;
                    case 'curriculum':
                        container.innerHTML = renderCurriculumCreator();
                        break;
                    case 'department':
                        container.innerHTML = renderDepartment(appState.activeDepartment);
                        break;
                    case 'paths':
                        container.innerHTML = renderLearningPaths();
                        break;
                    case 'item':
                        container.innerHTML = renderItemDetail(appState.activeItemId);
                        break;
                    case 'search':
                        container.innerHTML = renderSearchResults(appState.searchQuery);
                        break;
                }
            }

            // =================================================================================
            // VIEW TEMPLATES
            // =================================================================================
            function renderDashboard() {
                const recentlyAdded = Object.values(db.items).sort((a,b) => new Date(b.lastUpdated) - new Date(a.lastUpdated)).slice(0, 3);
                const pinned = Object.values(db.items).filter(item => appState.currentUser.pinnedItems.includes(item.id));
                const userPaths = Object.values(db.paths).filter(p => appState.currentUser.pathProgress[p.id]);

                return `
                    <h1 class="text-3xl font-bold mb-2">Welcome back, ${appState.currentUser.name.split(' ')[0]}!</h1>
                    <p class="text-slate-500 mb-8">Here's your learning snapshot for today.</p>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- My Learning Paths -->
                        <div class="lg:col-span-2 space-y-6">
                            <div class="content-card">
                                <h2 class="text-xl font-bold mb-4">My Learning Paths</h2>
                                <div class="space-y-4">
                                    ${userPaths.length > 0 ? userPaths.map(createPathProgressCard).join('') : '<p class="text-slate-500">You are not enrolled in any paths yet.</p>'}
                                </div>
                            </div>
                             <!-- Recently Added -->
                            <div class="content-card">
                                <h2 class="text-xl font-bold mb-4">What's New</h2>
                                <div class="space-y-3">${recentlyAdded.map(createListItem).join('')}</div>
                            </div>
                        </div>
                        
                        <!-- Pinned & Badges -->
                        <div class="space-y-6">
                            <div class="content-card">
                                <h2 class="text-xl font-bold mb-4">Pinned Resources</h2>
                                <div class="space-y-3">${pinned.length > 0 ? pinned.map(createListItem).join('') : '<p class="text-slate-500">Pin items for quick access!</p>'}</div>
                            </div>
                            <div class="content-card">
                                <h2 class="text-xl font-bold mb-4">My Badges</h2>
                                <div class="flex flex-wrap gap-4">
                                    ${createBadge('Estate Planning Expert', true)}
                                    ${createBadge('Elder Law Specialist', false)}
                                    ${createBadge('Medicaid Planning Pro', false)}
                                    ${createBadge('Trust Administration Master', false)}
                                </div>
                            </div>
                            ${(db.settings && db.settings.showIndustryUpdates !== false) ? `
                            <div class="content-card">
                                <h2 class="text-xl font-bold mb-4">Today's Featured Read</h2>
                                <p class="text-sm text-slate-600 mb-3">The most relevant or impactful read for your practice today.</p>
                                <div id="featured-read-content" class="text-sm text-slate-700 min-h-[60px]">
                                    <p class="text-slate-500">Loading...</p>
                                </div>
                                <button type="button" id="refresh-featured-read" class="mt-3 text-sm text-[var(--tnt-pink)] hover:underline">Refresh featured read</button>
                            </div>
                            <div class="content-card">
                                <h2 class="text-xl font-bold mb-4">Industry Updates & Trends</h2>
                                <p class="text-sm text-slate-600 mb-3">${getPracticeAreaLabel()}</p>
                                <div id="industry-updates-content" class="text-sm text-slate-700 space-y-2 min-h-[80px]">
                                    <p class="text-slate-500">Loading...</p>
                                </div>
                                <button type="button" id="refresh-industry-updates" class="mt-3 text-sm text-[var(--tnt-pink)] hover:underline">Refresh updates</button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            function renderDepartment(dept) {
                let items = Object.values(db.items).filter(i => i.department === dept);
                
                // Apply search filter
                if (appState.searchQuery) {
                    const query = appState.searchQuery.toLowerCase();
                    items = items.filter(item => 
                        item.title.toLowerCase().includes(query) ||
                        item.description.toLowerCase().includes(query) ||
                        item.type.toLowerCase().includes(query)
                    );
                }
                
                // Apply sorting
                if (appState.sortBy === 'name') {
                    items.sort((a, b) => a.title.localeCompare(b.title));
                } else if (appState.sortBy === 'date') {
                    items.sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated));
                }
                
                return `
                    <div class="space-y-6">
                        <div class="flex justify-between items-center">
                            <h1 class="text-3xl font-bold">${dept} Resources</h1>
                            <div class="flex items-center space-x-4">
                                <!-- Search Bar -->
                                <div class="relative">
                                    <input 
                                        type="text" 
                                        id="resource-search" 
                                        placeholder="Search resources..." 
                                        class="pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent"
                                        value="${appState.searchQuery || ''}"
                                    >
                                    <span data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></span>
                                </div>
                                
                                <!-- Sort Dropdown -->
                                <select id="sort-resources" class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                                    <option value="">Sort by...</option>
                                    <option value="name" ${appState.sortBy === 'name' ? 'selected' : ''}>Name (A-Z)</option>
                                    <option value="date" ${appState.sortBy === 'date' ? 'selected' : ''}>Date Added (Newest)</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Results Count -->
                        <div class="text-sm text-slate-600">
                            Showing ${items.length} of ${Object.values(db.items).filter(i => i.department === dept).length} resources
                            ${appState.searchQuery ? `for "${appState.searchQuery}"` : ''}
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            ${items.map(createItemCard).join('')}
                        </div>
                        
                        ${items.length === 0 ? `
                            <div class="text-center py-12">
                                <span data-lucide="search-x" class="w-12 h-12 text-slate-400 mx-auto mb-4"></span>
                                <h3 class="text-lg font-semibold text-slate-600 mb-2">No resources found</h3>
                                <p class="text-slate-500">Try adjusting your search or filters</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            function renderLearningPaths() {
                return `
                    <h1 class="text-3xl font-bold mb-8">Learning Paths</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${Object.values(db.paths).map(createPathCard).join('')}
                    </div>
                `;
            }
            
            function renderOnboarding() {
                const userOnboarding = Object.values(db.onboarding).filter(onboarding => 
                    onboarding.department === appState.currentUser.department || appState.currentUser.role === 'admin'
                );
                
                return `
                    <div class="space-y-8">
                        <div>
                            <h1 class="text-3xl font-bold mb-4">Onboarding</h1>
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-8">
                                <h2 class="text-lg font-semibold text-blue-900 mb-3">Why Complete Your Onboarding?</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm text-blue-800">
                                    <div>
                                        <h3 class="font-semibold mb-2">üéØ Essential Knowledge</h3>
                                        <p>Master the core processes, tools, and methodologies specific to your department. This ensures you can contribute effectively from day one.</p>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold mb-2">üìà Career Growth</h3>
                                        <p>Build a strong foundation that will accelerate your professional development and open doors to advanced opportunities within the team.</p>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold mb-2">ü§ù Team Alignment</h3>
                                        <p>Understand our company culture, values, and how your role fits into the bigger picture of The Siegel Law Group's mission.</p>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold mb-2">‚ö° Efficiency Boost</h3>
                                        <p>Learn proven workflows and best practices that will help you work smarter, not harder, and deliver exceptional results.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${userOnboarding.map(createOnboardingCard).join('')}
                        </div>
                    </div>
                `;
            }
            
            function renderOnboardingCurriculum() {
                const onboardingId = appState.activeOnboardingId;
                const onboarding = db.onboarding[onboardingId];
                
                if (!onboarding) {
                    return `<p>Error: Onboarding not found.</p>`;
                }
                
                const items = onboarding.itemIds.map(id => db.items[id]).filter(Boolean);
                const currentProgress = appState.currentUser.pathProgress[onboardingId] || 0;
                const completedItems = appState.currentUser.completedItems || [];
                const totalItems = items.length;
                const remainingItems = totalItems - currentProgress;
                const percentComplete = totalItems > 0 ? Math.round((currentProgress / totalItems) * 100) : 0;
                
                return `
                    <div class="space-y-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <button class="back-btn flex items-center text-sm text-slate-500 hover:text-slate-900 mb-4">
                                    <span data-lucide="arrow-left" class="w-4 h-4 mr-2"></span>
                                    Back to Onboarding
                                </button>
                                <h1 class="text-3xl font-bold mb-2">${onboarding.title}</h1>
                                <p class="text-slate-600">${onboarding.description}</p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-slate-900">${percentComplete}%</div>
                                <div class="text-sm text-slate-500">Complete</div>
                            </div>
                        </div>
                        
                        <!-- Progress Summary -->
                        <div class="bg-slate-50 rounded-lg p-6">
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div>
                                    <div class="text-2xl font-bold text-slate-900">${totalItems}</div>
                                    <div class="text-sm text-slate-500">Total Items</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-green-600">${currentProgress}</div>
                                    <div class="text-sm text-slate-500">Completed</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-orange-600">${remainingItems}</div>
                                    <div class="text-sm text-slate-500">Remaining</div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <div class="flex justify-between text-sm text-slate-500 mb-2">
                                    <span>Progress</span>
                                    <span>${currentProgress} / ${totalItems} Items</span>
                                </div>
                                <div class="w-full bg-slate-200 rounded-full h-3">
                                    <div class="bg-green-500 h-3 rounded-full" style="width: ${percentComplete}%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Curriculum Items -->
                        <div>
                            <h2 class="text-xl font-bold mb-4">Curriculum Items</h2>
                            <div class="space-y-4">
                                ${items.map((item, index) => {
                                    const isCompleted = completedItems.includes(item.id);
                                    const isNext = index === currentProgress;
                                    
                                    return `
                                        <div class="bg-white rounded-lg border p-4 ${isCompleted ? 'border-green-200 bg-green-50' : isNext ? 'border-blue-200 bg-blue-50' : ''}">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center">
                                                    <div class="w-8 h-8 rounded-full flex items-center justify-center mr-4 ${isCompleted ? 'bg-green-500 text-white' : isNext ? 'bg-blue-500 text-white' : 'bg-slate-200 text-slate-600'}">
                                                        ${isCompleted ? '<span data-lucide="check" class="w-5 h-5"></span>' : index + 1}
                                                    </div>
                                                    <div class="flex-1">
                                                        <h3 class="font-semibold text-slate-900">${item.title}</h3>
                                                        <p class="text-sm text-slate-500">${item.type} ‚Ä¢ ${item.department}</p>
                                                        <p class="text-sm text-slate-600 mt-1">${item.description}</p>
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-3">
                                                    ${isCompleted ? 
                                                        '<span class="text-green-600 text-sm font-medium">Completed</span>' : 
                                                        `<button class="start-item-btn bg-[var(--tnt-pink)] text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-[#d6005b] transition-colors" data-item-id="${item.id}">
                                                            ${isNext ? 'Start' : 'Continue'}
                                                        </button>`
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            function renderMembers() {
                const allMembers = Object.values(db.users).filter(user => user.role !== 'admin');
                const adminMembers = Object.values(db.users).filter(user => user.role === 'admin');
                
                // Debug: Log current user data
                console.log('Current user data:', db.users);
                
                return `
                    <div class="space-y-8">
                        <div class="flex justify-between items-center">
                            <h1 class="text-3xl font-bold">Team Members</h1>
                            <div class="flex space-x-3">
                                <button id="refresh-data-btn" class="bg-slate-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-slate-700 transition-colors flex items-center">
                                    <span data-lucide="refresh-cw" class="w-4 h-4 mr-2"></span>
                                    Refresh Data
                                </button>
                                <button id="add-member-btn" class="bg-[var(--tnt-pink)] text-white px-4 py-2 rounded-lg font-medium hover:bg-[#d6005b] transition-colors flex items-center">
                                    <span data-lucide="plus" class="w-4 h-4 mr-2"></span>
                                    Add Member
                                </button>
                            </div>
                        </div>
                        
                        <!-- Admin Members -->
                        <div>
                            <h2 class="text-xl font-semibold mb-4 text-slate-700">Administrators</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${adminMembers.map(createMemberCard).join('')}
                            </div>
                        </div>
                        
                        <!-- Team Members -->
                        <div>
                            <h2 class="text-xl font-semibold mb-4 text-slate-700">Team Members (${allMembers.length})</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${allMembers.map(createMemberCard).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            function renderMediaLibrary() {
                const mediaItems = db.mediaLibrary || {};
                const mediaArray = Object.values(mediaItems);
                
                return `
                    <div class="space-y-8">
                        <div class="flex justify-between items-center">
                            <h1 class="text-3xl font-bold">Media Library</h1>
                            <button id="add-media-btn" class="bg-[var(--tnt-pink)] text-white px-4 py-2 rounded-lg font-medium hover:bg-[#d6005b] transition-colors flex items-center">
                                <span data-lucide="plus" class="w-4 h-4 mr-2"></span>
                                Add Media
                            </button>
                        </div>
                        
                        <!-- Search and Filter -->
                        <div class="bg-white rounded-lg border p-6">
                            <div class="flex flex-col md:flex-row gap-4">
                                <div class="flex-1">
                                    <input type="text" id="media-search" placeholder="Search media..." class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                                </div>
                                <select id="media-filter" class="p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                                    <option value="">All Types</option>
                                    <option value="image">Images</option>
                                    <option value="video">Videos</option>
                                    <option value="document">Documents</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4">
                            ${mediaArray.map(createMediaCard).join('')}
                        </div>
                    </div>
                `;
            }
            
            function escapeAttr(s) {
                if (s == null || s === undefined) return '';
                return String(s).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            }

            function renderSettings() {
                const s = db.settings || {};
                const platformCrm = s.platformCrm || '';
                const companyName = s.companyName || '';
                const practiceArea = s.practiceArea || '';
                const showIndustryUpdates = s.showIndustryUpdates !== false;
                const specialistStyle = s.specialistStyle || 'detailed';
                const welcomeLine = s.welcomeLine || '';
                const companyWebsite = s.companyWebsite || '';
                const competitors = s.competitors || '';
                const servicesProducts = s.servicesProducts || '';
                return `
                    <div class="space-y-8">
                        <h1 class="text-3xl font-bold">Settings</h1>
                        <p class="text-slate-600">Platform-wide options. Changes here affect the whole team and make the app more personalized.</p>

                        <div class="content-card max-w-xl">
                            <h2 class="text-lg font-bold mb-4">Business info</h2>
                            <p class="text-sm text-slate-600 mb-3">Relevant details about your business. Used to personalize the app and AI (e.g. training specialist, industry updates).</p>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Business / practice name</label>
                            <input type="text" id="settings-company-name" value="${escapeAttr(companyName)}" placeholder="e.g. The Siegel Law Group, P.A." class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent mb-4">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Website</label>
                            <input type="url" id="settings-company-website" value="${escapeAttr(companyWebsite)}" placeholder="https://www.yourfirm.com" class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent mb-4">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Competitors (optional)</label>
                            <input type="text" id="settings-competitors" value="${escapeAttr(competitors)}" placeholder="e.g. Firm A, Firm B ‚Äî or leave blank" class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent mb-4">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Services / products</label>
                            <textarea id="settings-services-products" rows="3" placeholder="e.g. Estate planning, trusts, Medicaid planning, probate, elder law" class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">${escapeAttr(servicesProducts)}</textarea>
                            <p class="text-xs text-slate-500 mt-1">List main services or product lines. Helps tailor training and AI context.</p>
                        </div>

                        <div class="content-card max-w-xl">
                            <h2 class="text-lg font-bold mb-4">Company identity (display)</h2>
                            <p class="text-sm text-slate-600 mb-3">How your practice appears on the login screen and in the browser.</p>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Custom welcome line (optional)</label>
                            <input type="text" id="settings-welcome-line" value="${escapeAttr(welcomeLine)}" placeholder="e.g. Your training hub for estate planning excellence" class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                        </div>

                        <div class="content-card max-w-xl">
                            <h2 class="text-lg font-bold mb-4">Company CRM</h2>
                            <p class="text-sm text-slate-600 mb-3">Choose the CRM your team uses. The CRM tab will focus on this and show relevant curricula by role.</p>
                            <select id="settings-platform-crm" class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                                <option value="">‚Äî Select CRM ‚Äî</option>
                                ${POPULAR_CRMS.map(c => `<option value="${c.id}" ${platformCrm === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                            </select>
                        </div>

                        <div class="content-card max-w-xl">
                            <h2 class="text-lg font-bold mb-4">Dashboard & content</h2>
                            <p class="text-sm text-slate-600 mb-3">Control what appears on the dashboard and how AI content is tailored.</p>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Primary practice area</label>
                            <select id="settings-practice-area" class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent mb-4">
                                <option value="">‚Äî Select ‚Äî</option>
                                ${PRACTICE_AREAS.map(a => `<option value="${a.id}" ${practiceArea === a.id ? 'selected' : ''}>${a.name}</option>`).join('')}
                            </select>
                            <p class="text-xs text-slate-500 mb-2">Used for Industry Updates and AI context (e.g. estate planning, elder law).</p>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="settings-show-industry-updates" ${showIndustryUpdates ? 'checked' : ''} class="rounded border-slate-300 text-[var(--tnt-pink)] focus:ring-[var(--tnt-pink)]">
                                <span class="text-sm text-slate-700">Show Industry Updates & Trends on dashboard</span>
                            </label>
                        </div>

                        <div class="content-card max-w-xl">
                            <h2 class="text-lg font-bold mb-4">Training specialist (AI)</h2>
                            <p class="text-sm text-slate-600 mb-3">How the &quot;Ask the training specialist&quot; bot should answer on the CRM tab.</p>
                            <select id="settings-specialist-style" class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                                <option value="concise" ${specialistStyle === 'concise' ? 'selected' : ''}>Concise ‚Äî short, direct answers</option>
                                <option value="detailed" ${specialistStyle === 'detailed' ? 'selected' : ''}>Detailed ‚Äî full explanations with context</option>
                                <option value="step-by-step" ${specialistStyle === 'step-by-step' ? 'selected' : ''}>Step-by-step ‚Äî numbered instructions</option>
                            </select>
                        </div>

                        <div class="flex items-center gap-4">
                            <button type="button" id="settings-save-btn" class="px-6 py-2.5 bg-[var(--tnt-pink)] text-white rounded-lg font-medium hover:bg-[#d6005b]">Save all settings</button>
                            <span id="settings-save-hint" class="text-sm text-slate-500 hidden">Saving...</span>
                        </div>
                    </div>
                `;
            }
            
            function renderCRM() {
                const platformCrmId = (db.settings && db.settings.platformCrm) || null;
                const platformCrm = platformCrmId ? POPULAR_CRMS.find(c => c.id === platformCrmId) : null;
                const isAdmin = appState.currentUser && (appState.currentUser.accessLevel === 'admin' || appState.currentUser.role === 'creator');
                return `
                    <div class="space-y-8">
                        <h1 class="text-3xl font-bold">CRM Training</h1>
                        
                        <section class="content-card">
                            <h2 class="text-xl font-bold mb-2">Your CRM</h2>
                            ${platformCrm ? `
                                <p class="text-slate-600 mb-3">Your team uses <strong>${platformCrm.name}</strong>. Curricula below are tailored to this CRM.</p>
                                <a href="${platformCrm.academyUrl}" target="_blank" rel="noopener" class="inline-flex items-center text-[var(--tnt-pink)] hover:underline text-sm">
                                    <span data-lucide="external-link" class="w-4 h-4 mr-1"></span> Open ${platformCrm.name} Academy
                                </a>
                                ${isAdmin ? '<p class="text-xs text-slate-500 mt-2">Change CRM in <a href="#" class="settings-link text-[var(--tnt-pink)]">Settings</a>.</p>' : ''}
                            ` : `
                                <p class="text-slate-600">Your admin can set the company CRM in <strong>Settings</strong>. Once set, you'll see role-based curricula here.</p>
                            `}
                        </section>
                        
                        <section>
                            <h2 class="text-xl font-bold mb-4">Curriculums by department</h2>
                            <p class="text-slate-600 mb-6">Trainings for each role so everyone learns only what they need.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                ${CRM_DEPARTMENTS.map(dept => {
                                    const items = (db.crmCurricula[dept.id] && db.crmCurricula[dept.id].items) || [];
                                    return `
                                        <div class="content-card">
                                            <div class="flex justify-between items-start mb-3">
                                                <div>
                                                    <h3 class="font-semibold text-slate-900">${dept.name}</h3>
                                                    <p class="text-sm text-slate-500">${dept.description}</p>
                                                </div>
                                                ${isAdmin ? `<button type="button" class="crm-build-curriculum-btn px-3 py-1.5 bg-[var(--tnt-pink)] text-white rounded-lg text-sm font-medium hover:bg-[#d6005b]" data-dept-id="${dept.id}" data-dept-name="${dept.name}">Build curriculum</button>` : ''}
                                            </div>
                                            <ul class="space-y-4">
                                                ${items.length ? items.map((item, i) => {
                                                    const steps = (item.steps && item.steps.length) ? item.steps : [];
                                                    const desc = item.description || '';
                                                    return `
                                                    <li class="border border-slate-200 rounded-lg p-3 bg-slate-50/50">
                                                        <div class="flex justify-between items-start gap-2">
                                                            <div class="min-w-0 flex-1">
                                                                <a href="${item.url || '#'}" target="_blank" rel="noopener" class="font-medium text-[var(--tnt-pink)] hover:underline">${item.title}</a>
                                                                ${desc ? `<p class="text-xs text-slate-600 mt-1">${desc}</p>` : ''}
                                                            </div>
                                                            ${isAdmin ? `<button type="button" class="crm-remove-dept-item text-slate-400 hover:text-red-600 flex-shrink-0" data-dept-id="${dept.id}" data-index="${i}"><span data-lucide="trash-2" class="w-3.5 h-3.5"></span></button>` : ''}
                                                        </div>
                                                        ${steps.length ? `<div class="mt-2 pt-2 border-t border-slate-200"><p class="text-xs font-semibold text-slate-500 mb-1">Steps</p><ol class="list-decimal list-inside text-xs text-slate-700 space-y-0.5">${steps.map(s => `<li>${typeof s === 'object' && s.instruction ? s.instruction : s}</li>`).join('')}</ol></div>` : ''}
                                                    </li>
                                                    `;
                                                }).join('') : '<li class="text-slate-500 text-sm">No resources yet.</li>'}
                                            </ul>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </section>

                        <section class="content-card mt-8">
                            <h2 class="text-xl font-bold mb-2">Ask the training specialist</h2>
                            <p class="text-slate-600 mb-4">Ask a question about the curriculum or how to do something in the CRM. Answers are based on your training materials and best practices.</p>
                            <div class="flex gap-2 mb-4">
                                <input type="text" id="crm-specialist-question" placeholder="e.g. How do I log a call in HubSpot?" class="flex-1 p-3 border border-slate-300 rounded-lg text-sm" />
                                <button type="button" id="crm-specialist-ask" class="px-4 py-3 bg-[var(--tnt-pink)] text-white rounded-lg font-medium text-sm hover:bg-[#d6005b]">Ask</button>
                            </div>
                            <div id="crm-specialist-answer" class="hidden p-4 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-700 whitespace-pre-wrap"></div>
                            <div id="crm-specialist-loading" class="hidden p-4 text-slate-500 text-sm">Thinking...</div>
                        </section>
                    </div>
                `;
            }
            
            function renderCurriculumCreator() {
                const departments = ['Estate Planning', 'Elder Law', 'Medicaid Planning', 'Trust Administration', 'Probate', 'Marketing', 'Sales', 'Operations', 'Human Resources', 'Attorneys'];
                const allItems = Object.values(db.items);
                
                return `
                    <div class="space-y-8">
                        <div class="flex justify-between items-center">
                            <h1 class="text-3xl font-bold">Curriculum Creator</h1>
                            <button id="add-curriculum-step-btn" class="bg-[var(--tnt-pink)] text-white px-4 py-2 rounded-lg font-medium hover:bg-[#d6005b] transition-colors flex items-center">
                                <span data-lucide="plus" class="w-4 h-4 mr-2"></span>
                                Add Step to Curriculum
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Department Onboardings -->
                            <div class="lg:col-span-2">
                                <h2 class="text-xl font-semibold mb-4">Department Onboardings</h2>
                                <div class="space-y-4">
                                    ${departments.map(dept => {
                                        const onboardingId = `onboarding_${dept.toLowerCase().replace(/\s+/g, '_')}`;
                                        const onboarding = db.onboarding[onboardingId];
                                        const items = onboarding ? onboarding.itemIds.map(id => db.items[id]).filter(Boolean) : [];
                                        const videos = items.filter(item => item.type === 'Training').length;
                                        const docs = items.filter(item => item.type !== 'Training').length;
                                        
                                        return `
                                            <div class="bg-white rounded-lg border p-6">
                                                <div class="flex justify-between items-start mb-4">
                                                    <div>
                                                        <h3 class="text-lg font-semibold">${dept} Onboarding</h3>
                                                        <p class="text-sm text-slate-600 mt-1">Complete curriculum for new ${dept} team members</p>
                                                    </div>
                                                    <div class="flex space-x-2">
                                                        <button class="reorder-curriculum-btn bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1 rounded-md text-sm font-medium transition-colors" data-department="${dept}" data-onboarding-id="${onboardingId}">
                                                            Reorder Steps
                                                        </button>
                                                        <button class="edit-curriculum-btn bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1 rounded-md text-sm font-medium transition-colors" data-department="${dept}" data-onboarding-id="${onboardingId}">
                                                            Edit Curriculum
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                <div class="grid grid-cols-3 gap-4 text-center">
                                                    <div class="bg-blue-50 rounded-lg p-3">
                                                        <div class="text-2xl font-bold text-blue-600">${items.length}</div>
                                                        <div class="text-xs text-blue-600">Total Steps</div>
                                                    </div>
                                                    <div class="bg-green-50 rounded-lg p-3">
                                                        <div class="text-2xl font-bold text-green-600">${videos}</div>
                                                        <div class="text-xs text-green-600">Videos</div>
                                                    </div>
                                                    <div class="bg-purple-50 rounded-lg p-3">
                                                        <div class="text-2xl font-bold text-purple-600">${docs}</div>
                                                        <div class="text-xs text-purple-600">Documents</div>
                                                    </div>
                                                </div>
                                                
                                                ${items.length > 0 ? `
                                                    <div class="mt-4">
                                                        <h4 class="font-medium text-sm mb-2">Current Steps:</h4>
                                                        <div class="space-y-2">
                                                            ${items.map((item, index) => `
                                                                <div class="flex items-center justify-between bg-slate-50 rounded-lg p-2">
                                                                    <div class="flex items-center">
                                                                        <span class="text-xs bg-slate-200 text-slate-600 px-2 py-1 rounded mr-2">${index + 1}</span>
                                                                        <span class="text-sm font-medium">${item.title}</span>
                                                                        <span class="text-xs text-slate-500 ml-2">${item.type}</span>
                                                                    </div>
                                                                    <button class="remove-step-btn text-red-500 hover:text-red-700 text-sm" data-item-id="${item.id}" data-department="${dept}">
                                                                        <span data-lucide="x" class="w-4 h-4"></span>
                                                                    </button>
                                                                </div>
                                                            `).join('')}
                                                        </div>
                                                    </div>
                                                ` : '<p class="text-sm text-slate-500 mt-4">No steps added yet. Click "Edit Curriculum" to get started.</p>'}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            
                            <!-- Available Resources -->
                            <div>
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-xl font-semibold">Available Resources</h2>
                                    <div class="flex items-center space-x-3">
                                        <!-- Search Bar -->
                                        <div class="relative">
                                            <input 
                                                type="text" 
                                                id="curriculum-resource-search" 
                                                placeholder="Search resources..." 
                                                class="pl-8 pr-3 py-1 text-sm border border-slate-300 rounded-md focus:ring-1 focus:ring-[var(--tnt-pink)] focus:border-transparent"
                                            >
                                            <span data-lucide="search" class="w-3 h-3 absolute left-2 top-1/2 transform -translate-y-1/2 text-slate-400"></span>
                                        </div>
                                        
                                        <!-- Sort Dropdown -->
                                        <select id="curriculum-sort-resources" class="px-3 py-1 text-sm border border-slate-300 rounded-md focus:ring-1 focus:ring-[var(--tnt-pink)] focus:border-transparent">
                                            <option value="">Sort by...</option>
                                            <option value="name">Name (A-Z)</option>
                                            <option value="date">Date Added (Newest)</option>
                                            <option value="department">Department</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="space-y-2 max-h-96 overflow-y-auto">
                                    ${(() => {
                                        let filteredItems = allItems;
                                        
                                        // Apply search filter
                                        const searchInput = document.getElementById('curriculum-resource-search');
                                        if (searchInput && searchInput.value) {
                                            const query = searchInput.value.toLowerCase();
                                            filteredItems = filteredItems.filter(item => 
                                                item.title.toLowerCase().includes(query) ||
                                                item.description.toLowerCase().includes(query) ||
                                                item.department.toLowerCase().includes(query) ||
                                                item.type.toLowerCase().includes(query)
                                            );
                                        }
                                        
                                        // Apply sorting
                                        const sortSelect = document.getElementById('curriculum-sort-resources');
                                        if (sortSelect && sortSelect.value) {
                                            if (sortSelect.value === 'name') {
                                                filteredItems.sort((a, b) => a.title.localeCompare(b.title));
                                            } else if (sortSelect.value === 'date') {
                                                filteredItems.sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated));
                                            } else if (sortSelect.value === 'department') {
                                                filteredItems.sort((a, b) => a.department.localeCompare(b.department));
                                            }
                                        }
                                        
                                        return filteredItems.map(item => `
                                            <div class="flex items-center justify-between p-3 border rounded-lg hover:bg-slate-50">
                                                <div class="flex-1">
                                                    <p class="text-sm font-medium">${item.title}</p>
                                                    <p class="text-xs text-slate-500">${item.department} ‚Ä¢ ${item.type}</p>
                                                </div>
                                                <button class="add-to-curriculum-btn text-[var(--tnt-pink)] hover:text-[#d6005b] text-xs font-medium" data-item-id="${item.id}">
                                                    Add to Curriculum
                                                </button>
                                            </div>
                                        `).join('');
                                    })()}
                                </div>
                                
                                ${(() => {
                                    const searchInput = document.getElementById('curriculum-resource-search');
                                    const filteredItems = searchInput && searchInput.value ? 
                                        allItems.filter(item => 
                                            item.title.toLowerCase().includes(searchInput.value.toLowerCase()) ||
                                            item.description.toLowerCase().includes(searchInput.value.toLowerCase()) ||
                                            item.department.toLowerCase().includes(searchInput.value.toLowerCase()) ||
                                            item.type.toLowerCase().includes(searchInput.value.toLowerCase())
                                        ) : allItems;
                                    
                                    return filteredItems.length === 0 ? `
                                        <div class="text-center py-8">
                                            <span data-lucide="search-x" class="w-8 h-8 text-slate-400 mx-auto mb-2"></span>
                                            <p class="text-sm text-slate-500">No resources found</p>
                                        </div>
                                    ` : '';
                                })()}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            function renderItemDetail(itemId) {
                const item = db.items[itemId];
                if (!item) return `<p>Error: Item not found.</p>`;
                
                const avgRating = item.ratings.length > 0 ? (item.ratings.reduce((a, b) => a + b, 0) / item.ratings.length).toFixed(1) : 'No ratings';

                return `
                    <div class="max-w-4xl mx-auto">
                        <button class="back-btn flex items-center text-sm text-slate-500 hover:text-slate-900 mb-6">
                            <span data-lucide="arrow-left" class="w-4 h-4 mr-2"></span>
                            Back to ${item.department}
                        </button>

                        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                            ${item.type === 'Training' ? `<div class="aspect-video bg-black"><iframe class="w-full h-full" src="${getEmbedUrl(item.url)}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>` : ''}
                            
                            <div class="p-8">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-sm font-bold text-[var(--tnt-pink)] uppercase">${item.type}</p>
                                        <h1 class="text-4xl font-bold mt-1">${item.title}</h1>
                                    </div>
                                    <div class="flex space-x-3">
                                        <button id="mark-complete-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors flex items-center" data-item-id="${item.id}">
                                            <span data-lucide="check" class="w-4 h-4 mr-2"></span>
                                            Mark Complete
                                        </button>
                                        <a href="${item.url}" target="_blank" class="tnt-button font-semibold py-2 px-4 rounded-lg flex items-center transition-colors text-sm">
                                            <span data-lucide="external-link" class="w-4 h-4 mr-2"></span>
                                            View Original
                                        </a>
                                    </div>
                                </div>
                                <p class="text-slate-600 mt-4">${item.description}</p>
                                
                                <div class="flex items-center mt-6 border-t border-b border-slate-200 py-4">
                                    <!-- Skills -->
                                    <div class="flex-1">
                                        <h3 class="text-xs uppercase font-semibold text-slate-400 mb-2">Skills Covered</h3>
                                        <div class="flex flex-wrap gap-2">
                                            ${item.skills.map(skill => `<span class="bg-slate-100 text-slate-700 text-xs font-medium px-2.5 py-1 rounded-full">${skill}</span>`).join('')}
                                        </div>
                                    </div>
                                    <!-- Rating -->
                                    <div class="text-right">
                                        <h3 class="text-xs uppercase font-semibold text-slate-400 mb-2">Average Rating</h3>
                                        <div class="flex items-center gap-2">
                                            <div class="flex text-amber-400">${[1,2,3,4,5].map(i => `<span data-lucide="star" class="w-5 h-5 ${i <= Math.round(avgRating) ? 'fill-current' : ''}"></span>`).join('')}</div>
                                            <span class="font-bold text-lg">${avgRating}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Comments Section -->
                                <div class="mt-8">
                                    <h2 class="text-xl font-bold mb-4">Discussion</h2>
                                    <div class="space-y-4">
                                        ${item.comments.map(c => createComment(c)).join('')}
                                    </div>
                                    <div class="mt-6 flex items-start space-x-3">
                                        <img src="${appState.currentUser.avatar}" class="w-10 h-10 rounded-full">
                                        <textarea class="flex-1 p-2 border rounded-md" placeholder="Add a comment..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            function renderSearchResults(query) {
                const results = Object.values(db.items).filter(item => 
                    item.title.toLowerCase().includes(query.toLowerCase()) ||
                    item.description.toLowerCase().includes(query.toLowerCase()) ||
                    item.department.toLowerCase().includes(query.toLowerCase()) ||
                    item.skills.some(skill => skill.toLowerCase().includes(query.toLowerCase()))
                );
                
                return `
                    <h1 class="text-3xl font-bold mb-2">Search Results</h1>
                    <p class="text-slate-500 mb-8">Found ${results.length} results for "${query}"</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        ${results.map(createItemCard).join('')}
                    </div>
                `;
            }

            // =================================================================================
            // COMPONENT CREATORS
            // =================================================================================
            function createItemCard(item) {
                return `
                    <div class="bg-white rounded-lg shadow-sm overflow-hidden flex flex-col group transition-all duration-300 hover:shadow-xl hover:-translate-y-1 cursor-pointer" data-view="item" data-item-id="${item.id}">
                        <div class="relative h-40 bg-slate-200">
                            <img src="${getThumbnailUrl(item)}" alt="${item.title}" class="w-full h-full object-cover">
                            ${item.type === 'Training' ? '<div class="absolute inset-0 bg-black/20"></div><span data-lucide="play-circle" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-12 h-12 text-white/80"></span>' : ''}
                            ${appState.currentUser && (appState.currentUser.role === 'admin' || appState.currentUser.role === 'creator') ? `
                                <button class="absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity delete-item-btn" 
                                        title="Delete Resource" data-item-id="${item.id}" data-item-title="${item.title}">
                                    <span data-lucide="trash-2" class="w-4 h-4"></span>
                                </button>
                            ` : ''}
                        </div>
                        <div class="p-4 flex-grow flex flex-col">
                            <p class="text-xs font-bold text-[var(--tnt-pink)]">${item.type}</p>
                            <h3 class="font-bold text-slate-800 line-clamp-2 mt-1 flex-grow">${item.title}</h3>
                            <p class="text-xs text-slate-400 mt-2">By ${item.author}</p>
                        </div>
                    </div>`;
            }
            
            function createPathCard(path) {
                const progress = appState.currentUser.pathProgress[path.id] || 0;
                const total = path.itemIds.length;
                const percent = total > 0 ? Math.round((progress / total) * 100) : 0;
                return `
                    <div class="content-card">
                        <h3 class="font-bold text-lg">${path.title}</h3>
                        <p class="text-sm text-slate-500 mt-1 mb-4 h-10">${path.description}</p>
                        <div class="flex items-center justify-between text-sm text-slate-500 mb-2">
                            <span>Progress</span>
                            <span>${progress} / ${total} Steps</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2.5">
                            <div class="progress-bar-fill h-2.5 rounded-full" style="width: ${percent}%"></div>
                        </div>
                    </div>`;
            }
            
            function createOnboardingCard(onboarding) {
                const progress = appState.currentUser.pathProgress[onboarding.id] || 0;
                const total = onboarding.itemIds.length;
                const percent = total > 0 ? Math.round((progress / total) * 100) : 0;
                const isCompleted = percent === 100;
                
                // Get the actual items for this onboarding
                const onboardingItems = onboarding.itemIds.map(id => db.items[id]).filter(Boolean);
                const videos = onboardingItems.filter(item => item.type === 'Training').length;
                const docs = onboardingItems.filter(item => item.type !== 'Training').length;
                
                return `
                    <div class="content-card ${isCompleted ? 'border-2 border-green-200 bg-green-50' : ''}">
                        <div class="flex items-start justify-between mb-3">
                            <h3 class="font-bold text-lg">${onboarding.title}</h3>
                            <div class="flex items-center space-x-2">
                                ${isCompleted ? '<span data-lucide="check-circle" class="w-6 h-6 text-green-500"></span>' : ''}
                                ${appState.currentUser.role === 'creator' ? '<button class="text-slate-400 hover:text-slate-600" title="Manage Onboarding"><span data-lucide="settings" class="w-5 h-5"></span></button>' : ''}
                            </div>
                        </div>
                        <p class="text-sm text-slate-500 mb-4">${onboarding.description}</p>
                        
                        <!-- Progress Summary -->
                        <div class="bg-slate-50 rounded-lg p-3 mb-4">
                            <div class="flex items-center justify-between text-sm font-medium mb-2">
                                <span>Progress: ${percent}%</span>
                                <span>${progress} / ${total} Steps</span>
                            </div>
                            <div class="w-full bg-slate-200 rounded-full h-2.5 mb-3">
                                <div class="progress-bar-fill h-2.5 rounded-full" style="width: ${percent}%"></div>
                            </div>
                            <div class="flex items-center justify-between text-xs text-slate-500">
                                <span>üìπ ${videos} Videos</span>
                                <span>üìÑ ${docs} Documents</span>
                                <span>‚è±Ô∏è ${onboarding.estimatedTime}</span>
                            </div>
                        </div>
                        
                        <button class="w-full bg-[var(--tnt-pink)] text-white py-2 px-4 rounded-md text-sm font-medium hover:bg-[#d6005b] transition-colors onboarding-continue-btn" data-onboarding-id="${onboarding.id}">
                            ${isCompleted ? 'Review' : 'Continue'}
                        </button>
                    </div>`;
            }
            
            function createMediaCard(media) {
                const isImage = media.type === 'image';
                const isVideo = media.type === 'video';
                
                return `
                    <div class="bg-white rounded-lg border p-3 hover:shadow-md transition-shadow group">
                        <div class="relative aspect-square mb-3 bg-slate-100 rounded-lg overflow-hidden">
                            ${isImage ? `
                                <img src="${media.url}" alt="${media.title}" class="w-full h-full object-cover">
                            ` : isVideo ? `
                                <video src="${media.url}" class="w-full h-full object-cover" muted>
                                    <source src="${media.url}" type="video/mp4">
                                </video>
                                <div class="absolute inset-0 bg-black/20 flex items-center justify-center">
                                    <span data-lucide="play" class="w-8 h-8 text-white"></span>
                                </div>
                            ` : `
                                <div class="w-full h-full flex items-center justify-center">
                                    <span data-lucide="file-text" class="w-12 h-12 text-slate-400"></span>
                                </div>
                            `}
                            
                            <!-- Overlay with actions -->
                            <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center space-x-2">
                                <button class="bg-white/20 hover:bg-white/30 text-white p-2 rounded-full" title="Use in Resource" onclick="useMediaInResource('${media.id}')">
                                    <span data-lucide="plus" class="w-4 h-4"></span>
                                </button>
                                <button class="bg-white/20 hover:bg-white/30 text-white p-2 rounded-full" title="Copy URL" onclick="copyMediaUrl('${media.url}')">
                                    <span data-lucide="copy" class="w-4 h-4"></span>
                                </button>
                                <button type="button" class="delete-media-btn bg-red-500/80 hover:bg-red-600/80 text-white p-2 rounded-full" title="Delete" data-media-id="${media.id}" style="pointer-events:auto;cursor:pointer" onclick="if(typeof window.handleDeleteMedia==='function'){window.handleDeleteMedia(this.getAttribute('data-media-id'));}else{alert('Delete not available. Deploy the latest app-ui.html (firebase deploy --only hosting) and hard-refresh the page.');} return false;">
                                    <span data-lucide="trash-2" class="w-4 h-4"></span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <h4 class="font-medium text-sm text-slate-900 line-clamp-2 mb-1">${media.title}</h4>
                            <p class="text-xs text-slate-500">${media.type.toUpperCase()}</p>
                            <p class="text-xs text-slate-400">${media.department || 'General'}</p>
                            <a href="#" class="delete-media-link inline-block mt-2 text-xs text-red-600 hover:text-red-800 hover:underline" data-media-id="${media.id}">Delete</a>
                        </div>
                    </div>
                `;
            }
            
            function createMemberCard(member) {
                const onboardingProgress = getUserOnboardingProgress(member);
                const lastLoginDays = getDaysSinceLastLogin(member.lastLogin);
                
                return `
                    <div class="bg-white rounded-lg border p-4 hover:shadow-md transition-shadow">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center">
                                <img src="${member.avatar}" alt="${member.name}" class="w-12 h-12 rounded-full mr-3">
                                <div>
                                    <h3 class="font-semibold text-slate-900">${member.name}</h3>
                                    <p class="text-sm text-slate-500">${member.title}</p>
                                    <p class="text-xs text-slate-400">${member.department}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="px-2 py-1 text-xs rounded-full ${member.role === 'admin' ? 'bg-purple-100 text-purple-700' : member.role === 'creator' ? 'bg-orange-100 text-orange-700' : 'bg-sky-100 text-sky-700'}">
                                    ${member.role === 'admin' ? 'Admin' : member.role === 'creator' ? 'Creator' : 'Member'}
                                </span>
                                <span class="px-2 py-1 text-xs rounded-full ${member.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                    ${member.status}
                                </span>
                            </div>
                        </div>
                        
                        <div class="space-y-2 mb-3">
                            <div class="flex justify-between text-xs text-slate-500">
                                <span>Onboarding Progress</span>
                                <span>${onboardingProgress}%</span>
                            </div>
                            <div class="w-full bg-slate-200 rounded-full h-1.5">
                                <div class="bg-green-500 h-1.5 rounded-full" style="width: ${onboardingProgress}%"></div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center text-xs text-slate-400">
                            <span>${member.completedItems.length} resources completed</span>
                            <span>${lastLoginDays} days ago</span>
                        </div>
                        
                                                <div class="flex justify-end mt-3 space-x-2">
                            <button class="edit-member-btn text-slate-400 hover:text-slate-600 p-1" title="Edit Member" data-member-id="${member.id}">
                                <span data-lucide="edit" class="w-4 h-4"></span>
                                </button>
                            <button type="button" class="remove-member-btn text-slate-400 hover:text-red-600 p-1" title="Remove Member" data-member-id="${member.id}">
                                <span data-lucide="trash-2" class="w-4 h-4"></span>
                            </button>
                            </div>
                    </div>`;
            }
            
            function createPathProgressCard(path) {
                 const progress = appState.currentUser.pathProgress[path.id] || 0;
                 const total = path.itemIds.length;
                 const percent = total > 0 ? Math.round((progress / total) * 100) : 0;
                 return `
                    <div>
                        <div class="flex items-center justify-between text-sm mb-1">
                            <p class="font-semibold">${path.title}</p>
                            <p class="text-slate-500">${percent}%</p>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2">
                            <div class="progress-bar-fill h-2 rounded-full" style="width: ${percent}%"></div>
                        </div>
                    </div>
                 `;
            }

            function createListItem(item) {
                 return `<div class="flex items-center justify-between p-2 rounded-md hover:bg-slate-100 cursor-pointer" data-view="item" data-item-id="${item.id}">
                    <div class="flex items-center min-w-0"><span data-lucide="${getIconForDept(item.department)}" class="w-5 h-5 mr-3 text-slate-400 flex-shrink-0"></span>
                        <div class="min-w-0"><p class="font-semibold text-slate-700 truncate">${item.title}</p><p class="text-sm text-slate-500">${item.department}</p></div>
                    </div><span data-lucide="chevron-right" class="w-5 h-5 text-slate-400"></span>
                </div>`;
            }
            
            function createBadge(name, earned) {
                return `
                    <div class="text-center">
                        <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto ${earned ? 'bg-amber-100' : 'bg-slate-200'}">
                            <span data-lucide="award" class="w-10 h-10 ${earned ? 'text-amber-500' : 'text-slate-400'}"></span>
                        </div>
                        <p class="text-xs font-medium mt-2 ${earned ? 'text-slate-700' : 'text-slate-400'}">${name}</p>
                    </div>`;
            }
            
            function createComment(comment) {
                const user = db.users[comment.user];
                return `<div class="flex items-start space-x-3">
                    <img src="${user.avatar}" class="w-10 h-10 rounded-full">
                    <div class="flex-1">
                        <div class="bg-slate-100 rounded-lg p-3">
                            <p class="font-semibold text-sm">${user.name}</p>
                            <p class="text-sm">${comment.text}</p>
                        </div>
                        <p class="text-xs text-slate-400 mt-1">${comment.date}</p>
                    </div>
                </div>`;
            }

            // =================================================================================
            // EVENT LISTENERS
            // =================================================================================
            function setupEventListeners() {
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.getElementById('main-content');
                const globalSearch = document.getElementById('global-search');
                
                // Sidebar navigation
                sidebar.addEventListener('click', e => {
                    const link = e.target.closest('.sidebar-link');
                    const loginBtn = e.target.closest('#login-btn');
                    const logoutBtn = e.target.closest('#logout-btn');
                    const adminBtn = e.target.closest('#admin-btn');
                    const addResourceBtn = e.target.closest('#add-resource-btn');
                    
                    if (link) {
                        e.preventDefault();
                        appState.currentView = link.dataset.view;
                        appState.activeDepartment = link.dataset.dept || null;
                        render();
                    }
                    
                    if (loginBtn) {
                        e.preventDefault();
                        showModal('login-modal');
                    }
                    
                    if (logoutBtn) {
                        e.preventDefault();
                        logout();
                    }
                    
                    if (adminBtn) {
                        e.preventDefault();
                        showModal('admin-modal');
                        renderAdminDashboard();
                    }
                    
                    if (addResourceBtn) {
                        e.preventDefault();
                        showModal('add-resource-modal');
                    }
                });
                
                // Main content interactions
                mainContent.addEventListener('click', async e => {
                    const card = e.target.closest('[data-view="item"]');
                    const backBtn = e.target.closest('.back-btn');
                    const loginPromptBtn = e.target.closest('#login-prompt-btn');
                    const addMemberBtn = e.target.closest('#add-member-btn');
                    
                    if (card) {
                        appState.currentView = 'item';
                        appState.activeItemId = parseInt(card.dataset.itemId);
                        render();
                    }
                    if(backBtn) {
                        const item = db.items[appState.activeItemId];
                        appState.currentView = 'department';
                        appState.activeDepartment = item.department;
                        render();
                    }
                    if (loginPromptBtn) {
                        showModal('login-modal');
                    }
                    if (addMemberBtn) {
                        e.preventDefault();
                        showModal('add-member-modal');
                    }
                    
                    // Add curriculum step button
                    const addCurriculumStepBtn = e.target.closest('#add-curriculum-step-btn');
                    if (addCurriculumStepBtn) {
                        e.preventDefault();
                        showModal('add-curriculum-step-modal');
                    }
                    
                    // Add media button
                    const addMediaBtn = e.target.closest('#add-media-btn');
                    if (addMediaBtn) {
                        e.preventDefault();
                        showModal('add-media-modal');
                    }
                    
                    // Browse media button (in add resource modal)
                    const browseMediaBtn = e.target.closest('#browse-media-btn');
                    if (browseMediaBtn) {
                        e.preventDefault();
                        showMediaPicker();
                    }
                    
                    // Clear selected media
                    const clearSelectedMediaBtn = e.target.closest('#clear-selected-media');
                    if (clearSelectedMediaBtn) {
                        e.preventDefault();
                        clearSelectedMedia();
                    }
                    
                    // Select media from picker
                    const selectMediaCard = e.target.closest('.select-media-card');
                    if (selectMediaCard) {
                        e.preventDefault();
                        const mediaId = selectMediaCard.dataset.mediaId;
                        selectMediaForResource(mediaId);
                    }
                    
                    // Refresh data button
                    const refreshDataBtn = e.target.closest('#refresh-data-btn');
                    if (refreshDataBtn) {
                        e.preventDefault();
                        render();
                        showNotification('Data refreshed! Check console for debug info.', 'success');
                    }
                    
                    // Refresh industry updates (dashboard)
                    const refreshIndustryBtn = e.target.closest('#refresh-industry-updates');
                    if (refreshIndustryBtn) {
                        e.preventDefault();
                        loadIndustryUpdates();
                    }
                    // Refresh featured read (dashboard)
                    const refreshFeaturedBtn = e.target.closest('#refresh-featured-read');
                    if (refreshFeaturedBtn) {
                        e.preventDefault();
                        loadFeaturedRead();
                    }
                    
                    // Settings: save all settings
                    const settingsSaveBtn = e.target.closest('#settings-save-btn');
                    if (settingsSaveBtn) {
                        e.preventDefault();
                        db.settings = db.settings || {};
                        const companyNameEl = document.getElementById('settings-company-name');
                        const welcomeLineEl = document.getElementById('settings-welcome-line');
                        const companyWebsiteEl = document.getElementById('settings-company-website');
                        const competitorsEl = document.getElementById('settings-competitors');
                        const servicesProductsEl = document.getElementById('settings-services-products');
                        const platformCrmEl = document.getElementById('settings-platform-crm');
                        const practiceAreaEl = document.getElementById('settings-practice-area');
                        const showIndustryEl = document.getElementById('settings-show-industry-updates');
                        const specialistStyleEl = document.getElementById('settings-specialist-style');
                        if (companyNameEl) db.settings.companyName = companyNameEl.value.trim() || '';
                        if (welcomeLineEl) db.settings.welcomeLine = welcomeLineEl.value.trim() || '';
                        if (companyWebsiteEl) db.settings.companyWebsite = companyWebsiteEl.value.trim() || '';
                        if (competitorsEl) db.settings.competitors = competitorsEl.value.trim() || '';
                        if (servicesProductsEl) db.settings.servicesProducts = servicesProductsEl.value.trim() || '';
                        if (platformCrmEl) db.settings.platformCrm = platformCrmEl.value || null;
                        if (practiceAreaEl) db.settings.practiceArea = practiceAreaEl.value || '';
                        if (showIndustryEl) db.settings.showIndustryUpdates = showIndustryEl.checked;
                        if (specialistStyleEl) db.settings.specialistStyle = specialistStyleEl.value || 'detailed';
                        const hint = document.getElementById('settings-save-hint');
                        if (hint) { hint.classList.remove('hidden'); hint.textContent = 'Saving...'; }
                        await saveToFirebase('settings', db.settings);
                        if (hint) { hint.textContent = 'Saved.'; setTimeout(() => { hint.classList.add('hidden'); }, 1500); }
                        render();
                        updateDocumentTitle();
                        showNotification('Settings saved.', 'success');
                    }
                    
                    // CRM: link to Settings from "Your CRM"
                    const settingsLink = e.target.closest('.settings-link');
                    if (settingsLink) {
                        e.preventDefault();
                        appState.currentView = 'settings';
                        render();
                    }
                    
                    // CRM: Build curriculum (opens guided modal)
                    const crmBuildBtn = e.target.closest('.crm-build-curriculum-btn');
                    if (crmBuildBtn) {
                        e.preventDefault();
                        const deptId = crmBuildBtn.dataset.deptId;
                        const deptName = crmBuildBtn.dataset.deptName;
                        appState.crmBuilderDeptId = deptId;
                        appState.crmBuilderDeptName = deptName;
                        appState.crmBuilderPendingItems = [...((db.crmCurricula[deptId] && db.crmCurricula[deptId].items) || [])];
                        openCrmCurriculumBuilderModal();
                    }
                    
                    // CRM: remove item from department curriculum (on CRM tab list)
                    const crmRemoveDeptItem = e.target.closest('.crm-remove-dept-item');
                    if (crmRemoveDeptItem) {
                        e.preventDefault();
                        const deptId = crmRemoveDeptItem.dataset.deptId;
                        const index = parseInt(crmRemoveDeptItem.dataset.index, 10);
                        if (db.crmCurricula[deptId] && db.crmCurricula[deptId].items) {
                            db.crmCurricula[deptId].items.splice(index, 1);
                            saveToFirebase('crmCurricula', db.crmCurricula);
                            render();
                        }
                    }
                    
                    // Edit member button
                    const editMemberBtn = e.target.closest('.edit-member-btn');
                    if (editMemberBtn) {
                        e.preventDefault();
                        const memberId = editMemberBtn.dataset.memberId;
                        const member = db.users[memberId];
                        if (member) {
                            console.log('Editing member:', member); // Debug log
                            // Populate edit form
                            document.getElementById('edit-member-id').value = member.id;
                            document.getElementById('edit-member-name').value = member.name;
                            document.getElementById('edit-member-email').value = member.email;
                            document.getElementById('edit-member-title').value = member.title;
                            document.getElementById('edit-member-department').value = member.department;
                            document.getElementById('edit-member-role').value = member.role;
                            document.getElementById('edit-member-access').value = member.accessLevel || 'standard';
                            document.getElementById('edit-member-status').value = member.status;
                            
                            // Set avatar preview
                            const avatarPreview = document.getElementById('edit-member-avatar-preview');
                            if (avatarPreview && member.avatar) {
                                avatarPreview.src = member.avatar;
                            }
                            
                            showModal('edit-member-modal');
                        } else {
                            console.error('Member not found:', memberId); // Debug log
                        }
                    }
                    
                    // Remove member is handled by document-level listener so trash icon click is always caught
                    
                    // Onboarding management button
                    const onboardingManageBtn = e.target.closest('[title="Manage Onboarding"]');
                    if (onboardingManageBtn) {
                        e.preventDefault();
                        showModal('onboarding-management-modal');
                    }
                    
                    // Manage onboarding button in admin dashboard
                    const manageOnboardingBtn = e.target.closest('#manage-onboarding-btn');
                    if (manageOnboardingBtn) {
                        e.preventDefault();
                        showModal('onboarding-management-modal');
                    }
                    
                    // Curriculum Creator buttons
                    const editCurriculumBtn = e.target.closest('.edit-curriculum-btn');
                    const addToCurriculumBtn = e.target.closest('.add-to-curriculum-btn');
                    const removeStepBtn = e.target.closest('.remove-step-btn');
                    
                    if (editCurriculumBtn) {
                        e.preventDefault();
                        const department = editCurriculumBtn.dataset.department;
                        showNotification(`Editing ${department} curriculum. Use the "Add to Curriculum" buttons to add resources.`, 'info');
                    }
                    
                    if (addToCurriculumBtn) {
                        e.preventDefault();
                        const itemId = parseInt(addToCurriculumBtn.dataset.itemId);
                        const item = db.items[itemId];
                        
                        // For now, add to the department's onboarding
                        const department = item.department;
                        const onboardingKey = `onboarding_${department.toLowerCase().replace(/\s+/g, '_')}`;
                        
                        if (db.onboarding[onboardingKey]) {
                            if (!db.onboarding[onboardingKey].itemIds.includes(itemId)) {
                                db.onboarding[onboardingKey].itemIds.push(itemId);
                                
                                // Save to Firebase
                                await saveToFirebase('onboarding', db.onboarding);
                                
                                render();
                                showNotification(`Added "${item.title}" to ${department} onboarding!`, 'success');
                            } else {
                                showNotification('This resource is already in the curriculum.', 'info');
                            }
                        } else {
                            showNotification(`Onboarding not found for this department: ${onboardingKey}`, 'error');
                        }
                    }
                    
                    // Delete resource button
                    const deleteItemBtn = e.target.closest('.delete-item-btn');
                    if (deleteItemBtn) {
                        e.preventDefault();
                        e.stopPropagation();
                        const itemId = parseInt(deleteItemBtn.dataset.itemId);
                        const itemTitle = deleteItemBtn.dataset.itemTitle;
                        
                        console.log('Delete button clicked:', { itemId, itemTitle });
                        
                        // Show delete confirmation modal
                        document.getElementById('delete-resource-title').textContent = itemTitle;
                        document.getElementById('confirm-delete-resource').dataset.itemId = itemId;
                        showModal('delete-resource-modal');
                    }
                    
                    if (removeStepBtn) {
                        e.preventDefault();
                        const itemId = parseInt(removeStepBtn.dataset.itemId);
                        const department = removeStepBtn.dataset.department;
                        const onboardingKey = `onboarding_${department.toLowerCase().replace(/\s+/g, '_')}`;
                        
                        if (db.onboarding[onboardingKey]) {
                            const index = db.onboarding[onboardingKey].itemIds.indexOf(itemId);
                            if (index > -1) {
                                db.onboarding[onboardingKey].itemIds.splice(index, 1);
                                
                                // Save to Firebase
                                await saveToFirebase('onboarding', db.onboarding);
                                
                                render();
                                showNotification('Step removed from curriculum!', 'success');
                            }
                        }
                    }
                    
                    // Reorder curriculum button
                    const reorderCurriculumBtn = e.target.closest('.reorder-curriculum-btn');
                    if (reorderCurriculumBtn) {
                        e.preventDefault();
                        const department = reorderCurriculumBtn.dataset.department;
                        const onboardingKey = `onboarding_${department.toLowerCase().replace(/\s+/g, '_')}`;
                        const onboarding = db.onboarding[onboardingKey];
                        
                        if (onboarding && onboarding.itemIds.length > 0) {
                            // Set current department in appState
                            appState.currentDepartment = department;
                            
                            const items = onboarding.itemIds.map(id => db.items[id]).filter(Boolean);
                            const reorderContent = document.getElementById('reorder-content');
                            
                            reorderContent.innerHTML = `
                                <div class="mb-4">
                                    <h3 class="font-semibold mb-2">${department} Curriculum Steps</h3>
                                    <p class="text-sm text-slate-600">Click "Move to Position" to reorder steps</p>
                                </div>
                                <div id="reorder-list" class="space-y-3">
                                    ${items.map((item, index) => `
                                        <div class="flex items-center justify-between p-4 border rounded-lg bg-white" data-item-id="${item.id}" data-index="${index}">
                                            <div class="flex items-center">
                                                <span class="text-lg font-bold text-slate-400 mr-4">${index + 1}</span>
                                                <div>
                                                    <div class="text-sm font-medium">${item.title}</div>
                                                    <div class="text-xs text-slate-500">${item.type}</div>
                                                </div>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <span class="text-xs text-slate-400">Move to:</span>
                                                <select class="move-position-select text-xs border border-slate-300 rounded px-2 py-1" data-current-index="${index}">
                                                    ${items.map((_, pos) => `
                                                        <option value="${pos + 1}" ${pos + 1 === index + 1 ? 'selected' : ''}>Position ${pos + 1}</option>
                                                    `).join('')}
                                                </select>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                            
                            showModal('reorder-curriculum-modal');
                            lucide.createIcons();
                        } else {
                            showNotification('No steps to reorder.', 'info');
                        }
                    }
                    
                    // Onboarding continue button
                    const onboardingContinueBtn = e.target.closest('.onboarding-continue-btn');
                    if (onboardingContinueBtn) {
                        e.preventDefault();
                        const onboardingId = onboardingContinueBtn.dataset.onboardingId;
                        const onboarding = db.onboarding[onboardingId];
                        
                        if (onboarding && onboarding.itemIds.length > 0) {
                            // Navigate to the onboarding curriculum view
                            appState.currentView = 'onboarding-curriculum';
                            appState.activeOnboardingId = onboardingId;
                            render();
                        } else {
                            showNotification('No items found in this onboarding.', 'error');
                        }
                    }
                    
                    // Mark complete button
                    const markCompleteBtn = e.target.closest('#mark-complete-btn');
                    if (markCompleteBtn) {
                        e.preventDefault();
                        const itemId = parseInt(markCompleteBtn.dataset.itemId);
                        const item = db.items[itemId];
                        
                        if (item) {
                            // Add to completed items if not already there
                            if (!appState.currentUser.completedItems.includes(itemId)) {
                                appState.currentUser.completedItems.push(itemId);
                            }
                            
                            // Update onboarding progress
                            const userOnboardings = Object.values(db.onboarding).filter(o => 
                                o.department === appState.currentUser.department || appState.currentUser.role === 'admin'
                            );
                            
                            userOnboardings.forEach(onboarding => {
                                if (onboarding.itemIds.includes(itemId)) {
                                    const currentProgress = appState.currentUser.pathProgress[onboarding.id] || 0;
                                    appState.currentUser.pathProgress[onboarding.id] = currentProgress + 1;
                                }
                            });
                            
                            render();
                            showNotification(`Marked "${item.title}" as complete!`, 'success');
                        }
                    }
                    
                    // Start item button in onboarding curriculum
                    const startItemBtn = e.target.closest('.start-item-btn');
                    if (startItemBtn) {
                        e.preventDefault();
                        const itemId = parseInt(startItemBtn.dataset.itemId);
                        const item = db.items[itemId];
                        
                        if (item) {
                            // Navigate to the item detail
                            appState.currentView = 'item';
                            appState.activeItemId = itemId;
                            render();
                            showNotification(`Starting: ${item.title}`, 'success');
                        } else {
                            showNotification('Item not found.', 'error');
                        }
                    }
                });
                
                // Global search functionality
                globalSearch.addEventListener('input', (e) => {
                    const query = e.target.value.trim();
                    if (query.length > 0) {
                        appState.currentView = 'search';
                        appState.searchQuery = query;
                        render();
                    } else {
                        appState.currentView = 'dashboard';
                        render();
                    }
                });
                
                // Resource search functionality
                document.addEventListener('input', (e) => {
                    const resourceSearch = e.target.closest('#resource-search');
                    if (resourceSearch) {
                        appState.searchQuery = e.target.value;
                        render();
                    }
                });
                
                // Resource sort functionality
                document.addEventListener('change', (e) => {
                    const sortSelect = e.target.closest('#sort-resources');
                    if (sortSelect) {
                        appState.sortBy = e.target.value;
                        render();
                    }
                });
                
                // Curriculum resource search functionality
                document.addEventListener('input', (e) => {
                    const curriculumSearch = e.target.closest('#curriculum-resource-search');
                    if (curriculumSearch) {
                        render();
                    }
                });
                
                // Curriculum resource sort functionality
                document.addEventListener('change', (e) => {
                    const curriculumSort = e.target.closest('#curriculum-sort-resources');
                    if (curriculumSort) {
                        render();
                    }
                });
                
                // Save reorder button
                document.addEventListener('click', async (e) => {
                    const saveReorderBtn = e.target.closest('#save-reorder-btn');
                    if (saveReorderBtn) {
                        e.preventDefault();
                        
                        // Get the reordered items from the modal
                        const reorderList = document.getElementById('reorder-list');
                        if (reorderList) {
                            const reorderedItems = Array.from(reorderList.children).map((item, index) => ({
                                id: parseInt(item.dataset.itemId),
                                index: index
                            }));
                            
                            // Get the current department and onboarding
                            const currentDepartment = appState.currentDepartment;
                            const onboardingKey = `onboarding_${currentDepartment.toLowerCase().replace(/\s+/g, '_')}`;
                            
                            if (db.onboarding[onboardingKey]) {
                                // Reorder the itemIds array based on the new order
                                const newItemIds = reorderedItems.map(item => item.id);
                                db.onboarding[onboardingKey].itemIds = newItemIds;
                                
                                // Save to Firebase
                                await saveToFirebase('onboarding', db.onboarding);
                                
                                // Close modal and re-render
                                hideModal('reorder-curriculum-modal');
                                render();
                                showNotification('Curriculum steps reordered successfully!', 'success');
                            }
                        }
                    }
                });
                
                // Position dropdown for reordering
                document.addEventListener('change', (e) => {
                    const positionSelect = e.target.closest('.move-position-select');
                    if (positionSelect) {
                        const currentIndex = parseInt(positionSelect.dataset.currentIndex);
                        const newPosition = parseInt(positionSelect.value) - 1; // Convert to 0-based index
                        
                        if (currentIndex !== newPosition) {
                            const reorderList = document.getElementById('reorder-list');
                            const items = Array.from(reorderList.children);
                            
                            // Get the item to move
                            const itemToMove = items[currentIndex];
                            
                            // Remove the item from its current position
                            itemToMove.remove();
                            
                            // Insert it at the new position
                            if (newPosition >= items.length - 1) {
                                // Move to end
                                reorderList.appendChild(itemToMove);
                            } else {
                                // Insert before the item at the new position
                                const targetItem = items[newPosition];
                                reorderList.insertBefore(itemToMove, targetItem);
                            }
                            
                            // Update all position numbers and dropdowns
                            const updatedItems = Array.from(reorderList.children);
                            updatedItems.forEach((item, index) => {
                                // Update the position number
                                const positionNumber = item.querySelector('.text-lg');
                                if (positionNumber) {
                                    positionNumber.textContent = index + 1;
                                }
                                
                                // Update the dropdown
                                const dropdown = item.querySelector('.move-position-select');
                                if (dropdown) {
                                    dropdown.dataset.currentIndex = index;
                                    dropdown.value = index + 1;
                                    
                                    // Update all options
                                    dropdown.innerHTML = updatedItems.map((_, pos) => `
                                        <option value="${pos + 1}" ${pos + 1 === index + 1 ? 'selected' : ''}>Position ${pos + 1}</option>
                                    `).join('');
                                }
                                
                                // Update data-index
                                item.dataset.index = index;
                            });
                        }
                    }
                });
                
                // Remove member (document-level so trash icon click is always caught)
                document.addEventListener('click', async (e) => {
                    const removeMemberBtn = e.target.closest('.remove-member-btn');
                    if (removeMemberBtn) {
                        e.preventDefault();
                        e.stopPropagation();
                        const memberId = removeMemberBtn.dataset.memberId;
                        const member = db.users[memberId];
                        if (member && confirm(`Remove "${member.name}" from the team? They will lose access to the platform. This cannot be undone.`)) {
                            await handleRemoveMember(memberId);
                        }
                    }
                });
                
                // Delete media: (1) visible "Delete" link under each card - always works
                document.addEventListener('click', async (e) => {
                    const link = e.target.closest('a.delete-media-link');
                    if (link) {
                        e.preventDefault();
                        const mediaId = link.getAttribute('data-media-id');
                        if (!mediaId) return;
                        const media = db.mediaLibrary && (db.mediaLibrary[mediaId] || db.mediaLibrary[Number(mediaId)]);
                        if (!media) {
                            showNotification('Media item not found.', 'error');
                            return;
                        }
                        const title = (media.title || '').replace(/"/g, '');
                        if (!confirm(`Delete "${title}" from the Media Library? This cannot be undone.`)) return;
                        delete db.mediaLibrary[media.id];
                        try {
                            await saveToFirebase('mediaLibrary', db.mediaLibrary);
                            render();
                            showNotification(`"${title}" removed from Media Library.`, 'success');
                        } catch (err) {
                            console.error('Error deleting media:', err);
                            showNotification('Failed to save. Please try again.', 'error');
                        }
                        return;
                    }
                    // (2) overlay trash button
                    const deleteMediaBtn = e.target.closest('.delete-media-btn');
                    if (deleteMediaBtn) {
                        e.preventDefault();
                        e.stopPropagation();
                        const mediaId = deleteMediaBtn.getAttribute('data-media-id');
                        const mediaTitle = (deleteMediaBtn.getAttribute('data-media-title') || 'this item').replace(/"/g, '');
                        const media = db.mediaLibrary && (db.mediaLibrary[mediaId] || db.mediaLibrary[Number(mediaId)]);
                        if (media && confirm(`Delete "${mediaTitle}" from the Media Library? This cannot be undone.`)) {
                            delete db.mediaLibrary[media.id];
                            try {
                                await saveToFirebase('mediaLibrary', db.mediaLibrary);
                                render();
                                showNotification(`"${mediaTitle}" removed from Media Library.`, 'success');
                            } catch (err) {
                                console.error('Error deleting media:', err);
                                showNotification('Failed to save. Please try again.', 'error');
                            }
                        } else if (!media) {
                            showNotification('Media item not found.', 'error');
                        }
                    }
                }, true);
                
                // Modal interactions
                document.addEventListener('click', e => {
                    const closeBtn = e.target.closest('.close-modal-btn');
                    if (closeBtn) {
                        const modalId = closeBtn.dataset.modalId;
                        hideModal(modalId);
                    }
                });
                
                // CRM curriculum builder modal: remove item from pending list
                document.addEventListener('click', e => {
                    const removeBtn = e.target.closest('.crm-builder-remove-item');
                    if (removeBtn && appState.crmBuilderPendingItems) {
                        e.preventDefault();
                        const index = parseInt(removeBtn.dataset.index, 10);
                        appState.crmBuilderPendingItems.splice(index, 1);
                        updateCrmBuilderModalList();
                    }
                });
                
                // CRM curriculum builder: add custom resource
                document.addEventListener('click', e => {
                    if (e.target.closest('#crm-builder-add-custom')) {
                        e.preventDefault();
                        const titleEl = document.getElementById('crm-builder-custom-title');
                        const urlEl = document.getElementById('crm-builder-custom-url');
                        const descEl = document.getElementById('crm-builder-custom-desc');
                        const stepsEl = document.getElementById('crm-builder-custom-steps');
                        const title = titleEl && titleEl.value.trim();
                        const url = urlEl && urlEl.value.trim();
                        const description = descEl && descEl.value.trim();
                        const stepsText = stepsEl && stepsEl.value.trim();
                        const steps = stepsText ? stepsText.split(/\n/).map((line, idx) => ({ stepNumber: idx + 1, instruction: line.trim() })).filter(s => s.instruction) : [];
                        if (title && url) {
                            appState.crmBuilderPendingItems = appState.crmBuilderPendingItems || [];
                            appState.crmBuilderPendingItems.push({ title, url, type: 'Resource', ...(description && { description }), ...(steps.length && { steps }) });
                            if (titleEl) titleEl.value = '';
                            if (urlEl) urlEl.value = '';
                            if (descEl) descEl.value = '';
                            if (stepsEl) stepsEl.value = '';
                            updateCrmBuilderModalList();
                        }
                    }
                });
                
                // CRM curriculum builder: Save curriculum
                document.addEventListener('click', e => {
                    if (e.target.closest('#crm-builder-save')) {
                        e.preventDefault();
                        const deptId = appState.crmBuilderDeptId;
                        if (!deptId) return;
                        db.crmCurricula[deptId] = { items: [...(appState.crmBuilderPendingItems || [])] };
                        saveToFirebase('crmCurricula', db.crmCurricula);
                        hideModal('crm-curriculum-builder-modal');
                        render();
                        showNotification('Curriculum saved.', 'success');
                    }
                });
                
                // CRM curriculum builder: Get AI suggestions
                document.addEventListener('click', async (e) => {
                    if (!e.target.closest('#crm-builder-ai-suggest')) return;
                    e.preventDefault();
                    const deptId = appState.crmBuilderDeptId;
                    const deptName = appState.crmBuilderDeptName || deptId;
                    const platformCrmId = (db.settings && db.settings.platformCrm);
                    const platformCrm = platformCrmId ? POPULAR_CRMS.find(c => c.id === platformCrmId) : null;
                    const outEl = document.getElementById('crm-builder-ai-output');
                    const listEl = document.getElementById('crm-builder-suggestions-list');
                    if (!outEl || !listEl || !platformCrm) {
                        if (outEl) { outEl.classList.remove('hidden'); outEl.textContent = 'Set your company CRM in Settings first.'; }
                        return;
                    }
                    outEl.classList.remove('hidden');
                    outEl.textContent = 'Compiling curriculum from help center and best practices for ' + deptName + '...';
                    const prompt = `You are an advanced training specialist. For the role "${deptName}" using ${platformCrm.name} CRM, compile a short curriculum based on the CRM's help center and common YouTube/training resources. For each topic, provide: a title, a one-sentence description, 3-5 clear step-by-step instructions (SOP), and a suggested URL (use ${platformCrm.helpUrl} or academy URL when relevant). Respond with ONLY a valid JSON array, no other text. Each item must have: "title", "description", "steps" (array of objects with "stepNumber" and "instruction"), "url". Example format: [{"title":"...","description":"...","steps":[{"stepNumber":1,"instruction":"..."}],"url":"..."}]. Return 4-6 items.`;
                    const text = await callGemini(prompt);
                    let suggestions = [];
                    try {
                        const raw = (text || '').replace(/```json?\s*|\s*```/g, '').trim();
                        const parsed = JSON.parse(raw);
                        suggestions = Array.isArray(parsed) ? parsed.map(it => ({
                            title: it.title || 'Untitled',
                            description: it.description || '',
                            steps: Array.isArray(it.steps) ? it.steps.map((s, i) => ({ stepNumber: (s && s.stepNumber) || i + 1, instruction: (s && s.instruction) || String(s) })) : [],
                            url: it.url || platformCrm.helpUrl,
                            type: 'Training'
                        })) : [];
                    } catch (_) {
                        const lines = (text || '').split(/\n/).filter(l => l.trim());
                        suggestions = lines.slice(0, 6).map(line => {
                            const match = line.replace(/^\d+\.\s*/, '').trim().match(/^(.+?)(?:\s*[-‚Äì]\s*(.+))?$/);
                            const title = (match && match[1]) ? match[1].trim() : line.trim();
                            return { title, description: '', steps: [], url: platformCrm.helpUrl, type: 'Training' };
                        });
                    }
                    outEl.innerHTML = suggestions.length ? 'Add any item below to your curriculum.' : (text ? ('Could not parse suggestions. Raw: ' + (text.slice(0, 200) + (text.length > 200 ? '...' : ''))) : 'Could not load suggestions.');
                    listEl.innerHTML = suggestions.map((s, i) => `
                        <div class="p-2 bg-white border rounded text-sm">
                            <div class="flex justify-between items-start gap-2">
                                <span class="font-medium truncate flex-1">${s.title}</span>
                                <button type="button" class="crm-builder-add-suggestion flex-shrink-0 px-2 py-1 bg-[var(--tnt-pink)] text-white rounded text-xs" data-index="${i}">Add</button>
                            </div>
                            ${s.description ? `<p class="text-xs text-slate-600 mt-1">${s.description}</p>` : ''}
                            ${(s.steps && s.steps.length) ? `<ol class="list-decimal list-inside text-xs text-slate-500 mt-1">${s.steps.slice(0, 3).map(st => `<li>${st.instruction || st}</li>`).join('')}${s.steps.length > 3 ? '...' : ''}</ol>` : ''}
                        </div>
                    `).join('');
                    window._crmBuilderSuggestions = suggestions;
                });
                
                // CRM builder: Add suggested item to pending list
                document.addEventListener('click', e => {
                    const addBtn = e.target.closest('.crm-builder-add-suggestion');
                    if (addBtn && window._crmBuilderSuggestions) {
                        e.preventDefault();
                        const index = parseInt(addBtn.dataset.index, 10);
                        const item = window._crmBuilderSuggestions[index];
                        if (item) {
                            appState.crmBuilderPendingItems = appState.crmBuilderPendingItems || [];
                            if (!appState.crmBuilderPendingItems.some(i => i.title === item.title)) {
                                appState.crmBuilderPendingItems.push({ ...item, steps: item.steps || [] });
                                updateCrmBuilderModalList();
                            }
                        }
                    }
                });

                // Ask the training specialist
                document.addEventListener('click', async e => {
                    if (!e.target.closest('#crm-specialist-ask')) return;
                    e.preventDefault();
                    const inputEl = document.getElementById('crm-specialist-question');
                    const answerEl = document.getElementById('crm-specialist-answer');
                    const loadingEl = document.getElementById('crm-specialist-loading');
                    const question = inputEl && inputEl.value.trim();
                    if (!question) return;
                    const platformCrmId = (db.settings && db.settings.platformCrm);
                    const platformCrm = platformCrmId ? POPULAR_CRMS.find(c => c.id === platformCrmId) : null;
                    const crmName = platformCrm ? platformCrm.name : 'the CRM';
                    const style = (db.settings && db.settings.specialistStyle) || 'detailed';
                    const styleInstruction = style === 'concise' ? 'Give short, direct answers (2-4 sentences).' : style === 'step-by-step' ? 'Always give numbered step-by-step instructions where relevant.' : 'Give full explanations with context.';
                    if (answerEl) { answerEl.classList.add('hidden'); answerEl.textContent = ''; }
                    if (loadingEl) loadingEl.classList.remove('hidden');
                    const context = getCrmCurriculumContext();
                    const businessContext = getBusinessContextForAI();
                    const systemPrompt = `You are an advanced training specialist. Business context (from Settings‚Äîuse to tailor answers): ${businessContext}\n\nAnswer the student's question using the curriculum and training resources below. If the answer is in the curriculum, use it and cite it. You may also use your knowledge of ${crmName} help center and best practices. ${styleInstruction} Be clear and helpful.\n\nCurriculum and resources:\n${context}`;
                    const fullPrompt = systemPrompt + '\n\nStudent question: ' + question;
                    const answer = await callGemini(fullPrompt);
                    if (loadingEl) loadingEl.classList.add('hidden');
                    if (answerEl) {
                        answerEl.textContent = answer || 'Sorry, I could not generate an answer. Try rephrasing or check your connection.';
                        answerEl.classList.remove('hidden');
                    }
                });

                // Form submissions
                const loginForm = document.getElementById('login-form');
                const addResourceForm = document.getElementById('add-resource-form');
                const addMemberForm = document.getElementById('add-member-form');
                const editMemberForm = document.getElementById('edit-member-form');
                
                if (loginForm) {
                    loginForm.addEventListener('submit', handleLogin);
                }
                
                if (addResourceForm) {
                    addResourceForm.addEventListener('submit', handleAddResource);
                }
                
                if (addMemberForm) {
                    addMemberForm.addEventListener('submit', handleAddMember);
                }
                
                if (editMemberForm) {
                    editMemberForm.addEventListener('submit', handleEditMember);
                }
                
                const addCurriculumStepForm = document.getElementById('add-curriculum-step-form');
                if (addCurriculumStepForm) {
                    addCurriculumStepForm.addEventListener('submit', handleAddCurriculumStep);
                }
                
                // Add media form
                const addMediaForm = document.getElementById('add-media-form');
                if (addMediaForm) {
                    addMediaForm.addEventListener('submit', handleAddMedia);
                }
                
                // Confirm delete resource
                const confirmDeleteBtn = document.getElementById('confirm-delete-resource');
                if (confirmDeleteBtn) {
                    confirmDeleteBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        const itemId = parseInt(this.dataset.itemId);
                        if (itemId) {
                            // Create a mock event object with the itemId
                            const mockEvent = {
                                preventDefault: () => {},
                                target: {
                                    dataset: { itemId: itemId }
                                }
                            };
                            handleDeleteResource(mockEvent);
                        } else {
                            showNotification('Error: Item ID not found!', 'error');
                        }
                    });
                }
                
                // File upload preview listeners
                const editMemberAvatar = document.getElementById('edit-member-avatar');
                if (editMemberAvatar) {
                    editMemberAvatar.addEventListener('change', function() {
                        previewImage(this, 'edit-member-avatar-preview');
                    });
                }
                
                // Select avatar from media library button
                const selectAvatarFromMediaBtn = document.getElementById('select-avatar-from-media');
                if (selectAvatarFromMediaBtn) {
                    selectAvatarFromMediaBtn.addEventListener('click', function() {
                        renderAvatarMediaLibrary();
                        showModal('select-avatar-modal');
                    });
                }
                
                // Avatar media library search and filter
                const avatarSearch = document.getElementById('avatar-search');
                const avatarFilter = document.getElementById('avatar-filter');
                
                if (avatarSearch) {
                    avatarSearch.addEventListener('input', function() {
                        renderAvatarMediaLibrary();
                    });
                }
                
                if (avatarFilter) {
                    avatarFilter.addEventListener('change', function() {
                        renderAvatarMediaLibrary();
                    });
                }
                
                // Cancel upload button
                const cancelUploadBtn = document.getElementById('cancel-upload-btn');
                if (cancelUploadBtn) {
                    cancelUploadBtn.addEventListener('click', function() {
                        hideUploadProgress();
                        showNotification('Upload cancelled', 'info');
                    });
                }
            }

            // =================================================================================
            // AUTHENTICATION & RESOURCE MANAGEMENT
            // =================================================================================
            function handleLogin(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                // Check if user exists in credentials
                const credentials = db.credentials[email];
                const user = Object.values(db.users).find(u => u.email === email);
                
                if (user && credentials && password === 'siegel') { // In real app, verify against passwordHash
                    // Update last login
                    user.lastLogin = new Date().toISOString().split('T')[0];
                    
                    appState.currentUser = user;
                    appState.isAuthenticated = true;
                    
                    // Save login state to localStorage
                    localStorage.setItem('tslg_login_state', JSON.stringify({
                        email: email,
                        timestamp: Date.now()
                    }));
                    
                    hideModal('login-modal');
                    render();
                    showNotification('Login successful!', 'success');
                } else {
                    showNotification('Invalid credentials. Try: bsiegel@siegellawgroup.com / siegel', 'error');
                }
            }
            
            function logout() {
                appState.currentUser = null;
                appState.isAuthenticated = false;
                appState.currentView = 'dashboard';
                
                // Clear login state from localStorage
                localStorage.removeItem('tslg_login_state');
                
                render();
                showNotification('Logged out successfully', 'success');
            }
            
            async function handleAddResource(e) {
                e.preventDefault();
                
                const resourceFile = document.getElementById('resource-file').files[0];
                const resourceUrl = document.getElementById('resource-url').value;
                const selectedMedia = window.selectedMediaForResource;
                
                // Validate that either URL, file, or selected media is provided
                if (!resourceUrl && !resourceFile && !selectedMedia) {
                    showNotification('Please provide either a URL, upload a file, or select from Media Library!', 'error');
                    return;
                }
                
                let finalUrl = resourceUrl;
                
                // If selected media is used, use its URL
                if (selectedMedia) {
                    finalUrl = selectedMedia.url;
                }
                // If file is uploaded, upload it to Firebase Storage
                else if (resourceFile) {
                    try {
                        finalUrl = await uploadFile(resourceFile, 'resources');
                    } catch (error) {
                        showNotification('File upload failed!', 'error');
                        return;
                    }
                }
                
                const newResource = {
                    id: Date.now(), // Simple ID generation
                    title: document.getElementById('resource-title').value,
                    type: document.getElementById('resource-type').value,
                    department: document.getElementById('resource-department').value,
                    author: document.getElementById('resource-author').value,
                    url: finalUrl,
                    description: document.getElementById('resource-description').value,
                    skills: document.getElementById('resource-skills').value.split(',').map(s => s.trim()).filter(s => s),
                    lastUpdated: new Date().toISOString().split('T')[0],
                    ratings: [],
                    comments: [],
                    isFileUpload: !!resourceFile // Track if this was a file upload
                };
                
                console.log('=== ADDING NEW RESOURCE ===');
                console.log('Resource:', newResource);
                console.log('Firebase available:', !!window.firebaseDb);
                console.log('Current items count:', Object.keys(db.items).length);
                
                // Add to database
                db.items[newResource.id] = newResource;
                console.log('Added to local db, new total items:', Object.keys(db.items).length);
                
                // Save to Firebase
                try {
                    console.log('Attempting to save to Firebase...');
                    await saveToFirebase('items', db.items);
                    console.log('‚úÖ Successfully saved to Firebase');
                    
                    // Verify the save by loading it back
                    const savedData = await loadFromFirebase('items');
                    console.log('Verification - loaded items count:', savedData ? Object.keys(savedData).length : 'No data');
                    
                } catch (error) {
                    console.error('‚ùå Error saving to Firebase:', error);
                    console.log('Falling back to localStorage...');
                    localStorage.setItem('tslg_items', JSON.stringify(db.items));
                }
                
                // Reset form and close modal
                e.target.reset();
                clearSelectedMedia(); // Clear any selected media
                hideModal('add-resource-modal');
                render();
                showNotification('Resource added successfully!', 'success');
            }
            
            async function handleDeleteResource(e) {
                e.preventDefault();
                
                console.log('=== HANDLE DELETE RESOURCE CALLED ===');
                console.log('Event target:', e.target);
                console.log('Dataset:', e.target.dataset);
                
                const itemId = parseInt(e.target.dataset.itemId);
                const item = db.items[itemId];
                
                console.log('Item ID:', itemId);
                console.log('Item found:', !!item);
                
                if (!item) {
                    showNotification('Resource not found!', 'error');
                    return;
                }
                
                console.log('=== DELETING RESOURCE ===');
                console.log('Item ID:', itemId);
                console.log('Item Title:', item.title);
                
                // Store current view state before deletion
                const currentView = appState.currentView;
                const currentDepartment = appState.activeDepartment;
                const currentSearchQuery = appState.searchQuery;
                const currentSortBy = appState.sortBy;
                
                console.log('Current view state:', { currentView, currentDepartment, currentSearchQuery, currentSortBy });
                
                // Remove from database
                delete db.items[itemId];
                console.log('Removed from local db, new total items:', Object.keys(db.items).length);
                
                // Remove from all onboarding curricula
                Object.keys(db.onboarding).forEach(onboardingKey => {
                    const onboarding = db.onboarding[onboardingKey];
                    if (onboarding.itemIds && onboarding.itemIds.includes(itemId)) {
                        onboarding.itemIds = onboarding.itemIds.filter(id => id !== itemId);
                        console.log(`Removed from ${onboardingKey} curriculum`);
                    }
                });
                
                // Save to Firebase
                try {
                    console.log('Saving updated data to Firebase...');
                    await saveToFirebase('items', db.items);
                    await saveToFirebase('onboarding', db.onboarding);
                    console.log('‚úÖ Successfully saved to Firebase');
                } catch (error) {
                    console.error('‚ùå Error saving to Firebase:', error);
                    console.log('Falling back to localStorage...');
                    localStorage.setItem('tslg_items', JSON.stringify(db.items));
                    localStorage.setItem('tslg_onboarding', JSON.stringify(db.onboarding));
                }
                
                // Close modal
                hideModal('delete-resource-modal');
                
                // Restore view state and render
                appState.currentView = currentView;
                appState.activeDepartment = currentDepartment;
                appState.searchQuery = currentSearchQuery;
                appState.sortBy = currentSortBy;
                
                console.log('Restored view state:', { 
                    currentView: appState.currentView, 
                    currentDepartment: appState.activeDepartment,
                    currentSearchQuery: appState.searchQuery,
                    currentSortBy: appState.sortBy
                });
                
                // Force a complete re-render
                renderSidebar();
                renderMainContent();
                lucide.createIcons();
                
                showNotification(`Resource "${item.title}" deleted successfully!`, 'success');
            }
            
            async function handleAddMember(e) {
                e.preventDefault();
                
                const email = document.getElementById('member-email').value;
                const password = document.getElementById('member-password').value;
                const department = document.getElementById('member-department').value;
                
                // Check if email already exists
                if (db.credentials[email]) {
                    showNotification('Email already exists!', 'error');
                    return;
                }
                
                // Create new user
                const newUserId = `user_${Date.now()}`;
                const newUser = {
                    id: newUserId,
                    name: document.getElementById('member-name').value,
                    title: document.getElementById('member-title').value,
                    email: email,
                    avatar: 'https://i.ibb.co/2S8p5z3/avatar.png',
                    department: department,
                    role: document.getElementById('member-role').value,
                    accessLevel: 'standard',
                    completedItems: [],
                    pinnedItems: [],
                    pathProgress: { [`onboarding_${department.toLowerCase()}`]: 0 }, // Auto-enroll in department onboarding
                    lastLogin: null,
                    status: 'active',
                    joinDate: new Date().toISOString().split('T')[0]
                };
                
                // Create credentials
                const newCredentials = {
                    email: email,
                    passwordHash: `hashed_${password}`, // In real app, use bcrypt
                    salt: `salt_${Date.now()}`,
                    lastPasswordChange: new Date().toISOString().split('T')[0],
                    failedAttempts: 0,
                    lockedUntil: null
                };
                
                // Add to database
                db.users[newUserId] = newUser;
                db.credentials[email] = newCredentials;
                
                // Save to Firebase
                await saveToFirebase('users', db.users);
                await saveToFirebase('credentials', db.credentials);
                
                // Reset form and close modal
                e.target.reset();
                hideModal('add-member-modal');
                render();
                showNotification('Member added successfully! Auto-enrolled in ' + department + ' onboarding.', 'success');
            }
            
            async function handleEditMember(e) {
                e.preventDefault();
                
                const memberId = document.getElementById('edit-member-id').value;
                const member = db.users[memberId];
                
                if (!member) {
                    showNotification('Member not found!', 'error');
                    return;
                }
                
                // Handle profile picture upload or media library selection
                const avatarFile = document.getElementById('edit-member-avatar').files[0];
                const selectedAvatarMedia = window.selectedAvatarMedia;
                
                if (avatarFile) {
                    // Handle file upload
                    try {
                        const avatarUrl = await uploadFile(avatarFile, 'avatars');
                        member.avatar = avatarUrl;
                        console.log('Profile picture uploaded successfully');
                    } catch (error) {
                        console.log('Firebase upload failed, trying base64 fallback...');
                        // Fallback to base64 for images
                        if (avatarFile.type.startsWith('image/')) {
                            try {
                                const base64Url = await fileToBase64(avatarFile);
                                member.avatar = base64Url;
                                showNotification('Profile picture saved and synced to all devices. (Storage upload failed; image stored in profile.)', 'info');
                            } catch (fallbackError) {
                                console.error('Base64 fallback also failed:', fallbackError);
                                showNotification('Profile picture upload failed!', 'error');
                                return;
                            }
                        } else {
                            showNotification('Profile picture upload failed!', 'error');
                            return;
                        }
                    }
                } else if (selectedAvatarMedia) {
                    // Handle media library selection
                    member.avatar = selectedAvatarMedia.url;
                    console.log('Profile picture selected from media library:', selectedAvatarMedia.title);
                    // Clear the selected media
                    window.selectedAvatarMedia = null;
                }
                
                // Update member data
                member.name = document.getElementById('edit-member-name').value;
                member.title = document.getElementById('edit-member-title').value;
                member.email = document.getElementById('edit-member-email').value;
                member.department = document.getElementById('edit-member-department').value;
                member.role = document.getElementById('edit-member-role').value;
                member.accessLevel = document.getElementById('edit-member-access').value;
                member.status = document.getElementById('edit-member-status').value;
                
                // Update credentials if email changed
                const oldEmail = member.email;
                const newEmail = document.getElementById('edit-member-email').value;
                if (oldEmail !== newEmail && db.credentials[oldEmail]) {
                    db.credentials[newEmail] = db.credentials[oldEmail];
                    db.credentials[newEmail].email = newEmail;
                    delete db.credentials[oldEmail];
                }
                
                // Save to Firebase
                await saveToFirebase('users', db.users);
                await saveToFirebase('credentials', db.credentials);
                
                // Reset form and close modal
                e.target.reset();
                hideModal('edit-member-modal');
                render();
                showNotification('Member updated successfully!', 'success');
            }
            
            function openCrmCurriculumBuilderModal() {
                const deptId = appState.crmBuilderDeptId;
                const deptName = appState.crmBuilderDeptName || deptId;
                const platformCrm = (db.settings && db.settings.platformCrm) ? POPULAR_CRMS.find(c => c.id === db.settings.platformCrm) : null;
                const subtitle = document.getElementById('crm-builder-subtitle');
                if (subtitle) subtitle.textContent = platformCrm 
                    ? `Suggestions for ${deptName} using ${platformCrm.name}. Add only what this role needs‚Äîeverything stays in your training platform.`
                    : 'Set your company CRM in Settings first, then build role-based curricula here.';
                updateCrmBuilderModalList();
                document.getElementById('crm-builder-ai-output').classList.add('hidden');
                document.getElementById('crm-builder-suggestions-list').innerHTML = '';
                const customTitle = document.getElementById('crm-builder-custom-title');
                const customUrl = document.getElementById('crm-builder-custom-url');
                const customDesc = document.getElementById('crm-builder-custom-desc');
                const customSteps = document.getElementById('crm-builder-custom-steps');
                if (customTitle) customTitle.value = '';
                if (customUrl) customUrl.value = '';
                if (customDesc) customDesc.value = '';
                if (customSteps) customSteps.value = '';
                showModal('crm-curriculum-builder-modal');
                lucide.createIcons();
            }
            
            function updateCrmBuilderModalList() {
                const list = document.getElementById('crm-builder-items-list');
                if (!list) return;
                const items = appState.crmBuilderPendingItems || [];
                list.innerHTML = items.map((item, i) => {
                    const steps = (item.steps && item.steps.length) ? item.steps : [];
                    const desc = item.description || '';
                    return `
                    <li class="p-3 bg-slate-50 rounded-lg border border-slate-200 text-sm">
                        <div class="flex justify-between items-start gap-2">
                            <div class="min-w-0 flex-1">
                                <a href="${item.url || '#'}" target="_blank" rel="noopener" class="text-[var(--tnt-pink)] hover:underline font-medium">${item.title}</a>
                                ${desc ? `<p class="text-xs text-slate-600 mt-1">${desc}</p>` : ''}
                                ${steps.length ? `<ol class="list-decimal list-inside text-xs text-slate-600 mt-1">${steps.map(s => `<li>${typeof s === 'object' && s.instruction ? s.instruction : s}</li>`).join('')}</ol>` : ''}
                            </div>
                            <button type="button" class="crm-builder-remove-item text-slate-400 hover:text-red-600 flex-shrink-0" data-index="${i}"><span data-lucide="trash-2" class="w-4 h-4"></span></button>
                        </div>
                    </li>`;
                }).join('') || '<li class="text-slate-500 text-sm">No items yet. Use AI suggestions or add custom.</li>';
                lucide.createIcons();
            }
            
            async function handleRemoveMember(memberId) {
                const member = db.users[memberId];
                if (!member) {
                    showNotification('Member not found!', 'error');
                    return;
                }
                // Don't allow removing the currently logged-in user
                if (appState.currentUser && appState.currentUser.id === memberId) {
                    showNotification('You cannot remove yourself. Ask another admin to remove you.', 'error');
                    return;
                }
                // Don't allow removing the last admin
                const adminCount = Object.values(db.users).filter(u => u.role === 'admin').length;
                if (member.role === 'admin' && adminCount <= 1) {
                    showNotification('Cannot remove the last admin. Assign another admin first.', 'error');
                    return;
                }
                const email = member.email;
                delete db.users[memberId];
                if (email && db.credentials[email]) {
                    delete db.credentials[email];
                }
                try {
                    await saveToFirebase('users', db.users);
                    await saveToFirebase('credentials', db.credentials);
                    render();
                    showNotification(`"${member.name}" has been removed from the team.`, 'success');
                } catch (err) {
                    console.error('Error removing member:', err);
                    showNotification('Failed to save changes. Please try again.', 'error');
                }
            }
            
            async function handleAddCurriculumStep(e) {
                e.preventDefault();
                
                const newStep = {
                    id: Date.now(),
                    title: document.getElementById('curriculum-title').value,
                    type: document.getElementById('curriculum-type').value,
                    department: document.getElementById('curriculum-department').value,
                    author: document.getElementById('curriculum-author').value,
                    url: document.getElementById('curriculum-url').value,
                    description: document.getElementById('curriculum-description').value,
                    skills: document.getElementById('curriculum-skills').value.split(',').map(s => s.trim()).filter(s => s),
                    lastUpdated: new Date().toISOString().split('T')[0],
                    ratings: [],
                    comments: []
                };
                
                // Add to database
                db.items[newStep.id] = newStep;
                
                // Save to Firebase
                await saveToFirebase('items', db.items);
                
                // Reset form and close modal
                e.target.reset();
                hideModal('add-curriculum-step-modal');
                render();
                showNotification('Curriculum step added successfully!', 'success');
            }
            
            async function handleAddMedia(e) {
                e.preventDefault();
                
                const mediaFiles = document.getElementById('media-file').files;
                if (mediaFiles.length === 0) {
                    showNotification('Please select at least one file to upload!', 'error');
                    return;
                }
                
                try {
                    console.log('=== ADDING MEDIA TO LIBRARY ===');
                    console.log('Files selected:', mediaFiles.length);
                    
                    // Initialize mediaLibrary if it doesn't exist
                    if (!db.mediaLibrary) {
                        db.mediaLibrary = {};
                    }
                    
                    let uploadedCount = 0;
                    const totalFiles = mediaFiles.length;
                    
                    // Show bulk upload progress
                    showBulkUploadProgress(totalFiles);
                    
                    for (let i = 0; i < mediaFiles.length; i++) {
                        const mediaFile = mediaFiles[i];
                        console.log(`Processing file ${i + 1}/${totalFiles}:`, mediaFile.name);
                        
                        // Update progress
                        updateBulkUploadProgress(i + 1, totalFiles, mediaFile.name);
                        
                        try {
                            // Upload file to Firebase Storage
                            console.log('Uploading to Firebase Storage...');
                            let mediaUrl;
                            
                            try {
                                mediaUrl = await uploadFile(mediaFile, 'media-library');
                                console.log('Upload successful, URL:', mediaUrl);
                            } catch (firebaseError) {
                                console.log('Firebase upload failed, trying base64 fallback...');
                                // Fallback to base64 for images
                                if (mediaFile.type.startsWith('image/')) {
                                    try {
                                        const base64Url = await fileToBase64(mediaFile);
                                        mediaUrl = base64Url;
                                        console.log('Base64 fallback successful');
                                    } catch (fallbackError) {
                                        console.error('Base64 fallback also failed:', fallbackError);
                                        throw firebaseError; // Throw original error
                                    }
                                } else {
                                    throw firebaseError; // Throw original error for non-images
                                }
                            }
                            
                            // Generate title from filename if not provided
                            const title = mediaFiles.length === 1 ? 
                                document.getElementById('media-title').value : 
                                mediaFile.name.replace(/\.[^/.]+$/, ""); // Remove extension
                            
                            // Determine type from file
                            const type = getMediaTypeFromFile(mediaFile);
                            
                            const newMedia = {
                                id: Date.now() + i, // Unique ID for each file
                                title: title,
                                type: type,
                                department: document.getElementById('media-department').value || 'General',
                                tags: document.getElementById('media-tags').value.split(',').map(s => s.trim()).filter(s => s),
                                description: document.getElementById('media-description').value || `Uploaded ${mediaFile.name}`,
                                url: mediaUrl,
                                uploadedBy: appState.currentUser.name,
                                uploadedAt: new Date().toISOString().split('T')[0],
                                fileSize: mediaFile.size,
                                fileName: mediaFile.name
                            };
                            
                            console.log('Created media object:', newMedia);
                            
                            // Add to media library
                            db.mediaLibrary[newMedia.id] = newMedia;
                            uploadedCount++;
                            console.log(`Successfully added ${uploadedCount}/${totalFiles} files`);
                            
                        } catch (uploadError) {
                            console.error(`Error uploading file ${mediaFile.name}:`, uploadError);
                            throw uploadError; // Re-throw to be caught by outer catch
                        }
                    }
                    
                    console.log('All files processed, saving to Firebase...');
                    
                    // Save to Firebase
                    await saveToFirebase('mediaLibrary', db.mediaLibrary);
                    console.log('Successfully saved to Firebase');
                    
                    // Hide progress and close modal
                    hideBulkUploadProgress();
                    e.target.reset();
                    hideModal('add-media-modal');
                    render();
                    showNotification(`${uploadedCount} media items added to library successfully!`, 'success');
                    
                } catch (error) {
                    console.error('‚ùå Error adding media:', error);
                    console.error('Error details:', {
                        message: error.message,
                        stack: error.stack,
                        name: error.name
                    });
                    hideBulkUploadProgress();
                    showNotification('Failed to add media to library!', 'error');
                }
            }
            
            function renderAdminDashboard() {
                const adminContent = document.getElementById('admin-content');
                const allUsers = Object.values(db.users).filter(u => u.role !== 'admin' && u.role !== 'creator');
                const allItems = Object.values(db.items);
                
                adminContent.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Team Overview -->
                        <div class="lg:col-span-2">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold">Team Progress Overview</h3>
                                <button id="manage-onboarding-btn" class="bg-[var(--tnt-pink)] text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-[#d6005b] transition-colors">
                                    Manage Onboardings
                                </button>
                            </div>
                            <div class="space-y-4">
                                ${allUsers.map(user => `
                                    <div class="bg-white rounded-lg p-4 border">
                                        <div class="flex items-center justify-between mb-3">
                                            <div class="flex items-center">
                                                <img src="${user.avatar}" class="w-10 h-10 rounded-full mr-3">
                <div>
                                                    <p class="font-semibold">${user.name}</p>
                                                    <p class="text-sm text-slate-500">${user.title} - ${user.department}</p>
                    </div>
                </div>
                                            <span class="text-sm text-slate-500">${user.completedItems.length} completed</span>
                </div>
                                        <div class="space-y-2">
                                            <div class="flex justify-between text-xs">
                                                <span>Onboarding Progress</span>
                                                <span>${getUserOnboardingProgress(user)}%</span>
                </div>
                                            <div class="w-full bg-slate-200 rounded-full h-2">
                                                <div class="bg-green-500 h-2 rounded-full" style="width: ${getUserOnboardingProgress(user)}%"></div>
                </div>
                </div>
                </div>
                                `).join('')}
        </div>
    </div>

                        <!-- Quick Stats -->
                        <div class="space-y-4">
                            <div class="bg-white rounded-lg p-4 border">
                                <h4 class="font-semibold mb-3">Quick Stats</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span>Total Resources</span>
                                        <span class="font-semibold">${allItems.length}</span>
            </div>
                                    <div class="flex justify-between">
                                        <span>Active Users</span>
                                        <span class="font-semibold">${allUsers.length}</span>
                </div>
                                    <div class="flex justify-between">
                                        <span>Avg. Completion</span>
                                        <span class="font-semibold">${getAverageCompletion()}%</span>
                </div>
        </div>
    </div>

                            <div class="bg-white rounded-lg p-4 border">
                                <h4 class="font-semibold mb-3">Recent Activity</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex items-center">
                                        <span data-lucide="user" class="w-4 h-4 mr-2 text-slate-400"></span>
                                        <span>Alex completed Analytics onboarding</span>
            </div>
                                    <div class="flex items-center">
                                        <span data-lucide="plus" class="w-4 h-4 mr-2 text-slate-400"></span>
                                        <span>New Growth resource added</span>
                </div>
                </div>
                </div>
                </div>
                </div>
                `;
                lucide.createIcons();
            }
            
            function getUserOnboardingProgress(user) {
                const userOnboarding = Object.values(db.onboarding).find(o => o.department === user.department);
                if (!userOnboarding) return 0;
                
                const progress = user.pathProgress[userOnboarding.id] || 0;
                const total = userOnboarding.itemIds.length;
                return total > 0 ? Math.round((progress / total) * 100) : 0;
            }
            
            function completeOnboardingStep(userId, onboardingId, itemId) {
                const user = db.users[userId];
                if (!user) return false;
                
                const onboarding = db.onboarding[onboardingId];
                if (!onboarding || !onboarding.itemIds.includes(itemId)) return false;
                
                // Add item to completed items if not already there
                if (!user.completedItems.includes(itemId)) {
                    user.completedItems.push(itemId);
                }
                
                // Update onboarding progress
                const currentProgress = user.pathProgress[onboardingId] || 0;
                user.pathProgress[onboardingId] = currentProgress + 1;
                
                return true;
            }
            
            function getAverageCompletion() {
                const allUsers = Object.values(db.users).filter(u => u.role !== 'admin');
                if (allUsers.length === 0) return 0;
                
                const totalProgress = allUsers.reduce((sum, user) => sum + getUserOnboardingProgress(user), 0);
                return Math.round(totalProgress / allUsers.length);
            }
            
            function getDaysSinceLastLogin(lastLogin) {
                if (!lastLogin) return 'Never';
                const lastLoginDate = new Date(lastLogin);
                const today = new Date();
                const diffTime = Math.abs(today - lastLoginDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            }
            
            function showModal(modalId) {
                document.getElementById(modalId).classList.remove('hidden');
                document.getElementById(modalId).classList.add('flex');
            }
            
            function hideModal(modalId) {
                document.getElementById(modalId).classList.add('hidden');
                document.getElementById(modalId).classList.remove('flex');
            }
            
            function showNotification(message, type = 'success') {
                // Simple notification (in real app, use a proper notification system)
                alert(`${type.toUpperCase()}: ${message}`);
            }
            
            // =================================================================================
            // UTILITIES
            // =================================================================================
            function getThumbnailUrl(item) {
                if(item.type !== 'Training') return 'https://i.ibb.co/RzVztg5/doc-placeholder.png';
                try {
                    const url = item.url;
                    if (url.includes('youtube.com') || url.includes('youtu.be')) {
                        const videoId = new URL(url).searchParams.get('v') || url.split('/').pop();
                        return `https://i.ytimg.com/vi/${videoId}/mqdefault.jpg`;
                    }
                    if (url.includes('loom.com')) return `https://i.ibb.co/5Lqws19/loom-icon.png`;
                } catch (e) {}
                return 'https://i.ibb.co/kMcT2p9/vid-placeholder.png';
            }
            
            function getEmbedUrl(url) {
                try {
                    if(url.includes('youtube.com') || url.includes('youtu.be')) {
                        const videoId = new URL(url).searchParams.get('v') || url.split('/').pop();
                        return `https://www.youtube.com/embed/${videoId}?autoplay=1`;
                    } else if (url.includes('loom.com')) {
                        const videoId = url.split('/').pop().split('?')[0];
                        return `https://www.loom.com/embed/${videoId}?autoplay=1`;
                    }
                } catch(e) { return ''; }
                return url;
            }

            function getIconForDept(department) {
                switch (department.toLowerCase()) {
                    case 'dashboard': return 'layout-dashboard'; case 'analytics': return 'bar-chart-3';
                    case 'creative': return 'palette'; case 'growth': return 'trending-up';
                    case 'learning paths': return 'git-merge'; default: return 'file-text';
                }
            }
            
            // Media Library utility functions
            function copyMediaUrl(url) {
                navigator.clipboard.writeText(url).then(() => {
                    showNotification('URL copied to clipboard!', 'success');
                }).catch(() => {
                    showNotification('Failed to copy URL', 'error');
                });
            }
            
            function useMediaInResource(mediaId) {
                const media = db.mediaLibrary[mediaId];
                if (!media) {
                    showNotification('Media not found!', 'error');
                    return;
                }
                
                // Store the selected media for use in resource creation
                window.selectedMediaForResource = media;
                showNotification(`"${media.title}" selected for resource creation!`, 'success');
                
                // Close media library and go to dashboard to add resource
                appState.currentView = 'dashboard';
                render();
            }
            
            window.handleDeleteMedia = async function(mediaId) {
                const media = db.mediaLibrary && (db.mediaLibrary[mediaId] || db.mediaLibrary[Number(mediaId)]);
                if (!media) {
                    showNotification('Media item not found.', 'error');
                    return;
                }
                if (!confirm(`Delete "${(media.title || '').replace(/"/g, '')}" from the Media Library? This cannot be undone.`)) return;
                delete db.mediaLibrary[media.id];
                try {
                    await saveToFirebase('mediaLibrary', db.mediaLibrary);
                    render();
                    showNotification(`"${(media.title || '').replace(/"/g, '')}" removed from Media Library.`, 'success');
                } catch (err) {
                    console.error('Error deleting media:', err);
                    showNotification('Failed to save. Please try again.', 'error');
                }
            };
            
            function showMediaPicker() {
                // Populate the picker with media items
                populateMediaPicker();
                showModal('media-picker-modal');
            }
            
            function populateMediaPicker() {
                const mediaItems = db.mediaLibrary || {};
                const mediaArray = Object.values(mediaItems);
                const grid = document.getElementById('picker-media-grid');
                const noResults = document.getElementById('picker-no-results');
                
                if (mediaArray.length === 0) {
                    grid.innerHTML = '';
                    noResults.classList.remove('hidden');
                    return;
                }
                
                noResults.classList.add('hidden');
                grid.innerHTML = mediaArray.map(createPickerMediaCard).join('');
            }
            
            function createPickerMediaCard(media) {
                const isImage = media.type === 'image';
                const isVideo = media.type === 'video';
                
                return `
                    <div class="bg-white rounded-lg border p-3 hover:shadow-md transition-shadow cursor-pointer select-media-card" data-media-id="${media.id}">
                        <div class="relative aspect-square mb-3 bg-slate-100 rounded-lg overflow-hidden">
                            ${isImage ? `
                                <img src="${media.url}" alt="${media.title}" class="w-full h-full object-cover">
                            ` : isVideo ? `
                                <video src="${media.url}" class="w-full h-full object-cover" muted>
                                    <source src="${media.url}" type="video/mp4">
                                </video>
                                <div class="absolute inset-0 bg-black/20 flex items-center justify-center">
                                    <span data-lucide="play" class="w-8 h-8 text-white"></span>
                                </div>
                            ` : `
                                <div class="w-full h-full flex items-center justify-center">
                                    <span data-lucide="file-text" class="w-12 h-12 text-slate-400"></span>
                                </div>
                            `}
                            
                            <!-- Selection overlay -->
                            <div class="absolute inset-0 bg-blue-500/20 opacity-0 hover:opacity-100 transition-opacity flex items-center justify-center">
                                <span data-lucide="check-circle" class="w-8 h-8 text-white"></span>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <h4 class="font-medium text-sm text-slate-900 line-clamp-2 mb-1">${media.title}</h4>
                            <p class="text-xs text-slate-500">${media.type.toUpperCase()}</p>
                            <p class="text-xs text-slate-400">${media.department || 'General'}</p>
                        </div>
                    </div>
                `;
            }
            
            function clearSelectedMedia() {
                window.selectedMediaForResource = null;
                document.getElementById('selected-media-display').classList.add('hidden');
                document.getElementById('resource-url').value = '';
            }
            
            function selectMediaForResource(mediaId) {
                const media = db.mediaLibrary[mediaId];
                if (!media) {
                    showNotification('Media not found!', 'error');
                    return;
                }
                
                // Store selected media
                window.selectedMediaForResource = media;
                
                // Update the display
                document.getElementById('selected-media-title').textContent = media.title;
                document.getElementById('selected-media-display').classList.remove('hidden');
                
                // Close the picker modal
                hideModal('media-picker-modal');
                
                showNotification(`"${media.title}" selected for resource!`, 'success');
            }
            
            function getMediaTypeFromFile(file) {
                if (file.type.startsWith('image/')) return 'image';
                if (file.type.startsWith('video/')) return 'video';
                return 'document';
            }
            
            function showBulkUploadProgress(totalFiles) {
                // Create bulk upload progress modal if it doesn't exist
                if (!document.getElementById('bulk-upload-progress-modal')) {
                    const modal = document.createElement('div');
                    modal.id = 'bulk-upload-progress-modal';
                    modal.className = 'modal-overlay flex fixed inset-0 items-center justify-center p-4 bg-black/50';
                    modal.innerHTML = `
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                            <div class="flex items-center mb-4">
                                <span data-lucide="upload" class="w-6 h-6 text-blue-600 mr-3"></span>
                                <h3 class="text-lg font-semibold">Bulk Upload Progress</h3>
                            </div>
                            <div class="mb-4">
                                <div class="flex justify-between text-sm mb-2">
                                    <span id="bulk-progress-text">Uploading files...</span>
                                    <span id="bulk-progress-count">0/${totalFiles}</span>
                                </div>
                                <div class="w-full bg-slate-200 rounded-full h-2">
                                    <div id="bulk-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                            <div id="bulk-current-file" class="text-sm text-slate-600 mb-4"></div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                } else {
                    document.getElementById('bulk-upload-progress-modal').classList.remove('hidden');
                }
            }
            
            function updateBulkUploadProgress(current, total, fileName) {
                const progress = (current / total) * 100;
                document.getElementById('bulk-progress-bar').style.width = `${progress}%`;
                document.getElementById('bulk-progress-count').textContent = `${current}/${total}`;
                document.getElementById('bulk-current-file').textContent = `Uploading: ${fileName}`;
            }
            
            function hideBulkUploadProgress() {
                const modal = document.getElementById('bulk-upload-progress-modal');
                if (modal) {
                    modal.classList.add('hidden');
                }
            }
            
            // =================================================================================
            // INITIALIZATION
            // =================================================================================
            function initializeApp() {
                // Initialize Lucide icons
                lucide.createIcons();
                
                // Setup event listeners
                setupEventListeners();
                
                // Debug: Verify current titles
                console.log('Current team titles:');
                Object.values(db.users).forEach(user => {
                    console.log(`${user.name}: ${user.title}`);
                });
                
                // Render initial view
                render();
            }
            
            // --- INITIALIZE APP ---
            initializeApp();
        });
    </script>
</body>
</html>
